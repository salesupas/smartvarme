---
phase: 03-woocommerce-setup-product-display
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php
autonomous: true

must_haves:
  truths:
    - "All products from old site are accessible at their original URLs with correct data"
    - "No product URLs return 404 errors"
    - "301 redirects are configured for any URL structure changes"
    - "Product custom fields (stock display, delivery time) render correctly on product pages"
    - "Product archive pages load with working filtering and sorting"
    - "Variable products with 10+ variations display all variations correctly"
    - "WooCommerce HPOS is enabled and verified"
  artifacts:
    - path: "wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php"
      provides: "URL redirect handling for changed product URLs"
      contains: "redirect|301"
  key_links:
    - from: "product URLs"
      to: "product pages"
      via: "WordPress permalink rewrite rules"
      pattern: "product.*permalink"
    - from: "old product URLs"
      to: "new product URLs"
      via: "301 redirects in class-smartvarme-woocommerce.php"
      pattern: "wp_redirect.*301"
---

<objective>
Verify and preserve all product URLs from the current site, configure 301 redirects for any URL structure changes, and run comprehensive verification of all Phase 3 success criteria.

Purpose: URL preservation is critical for SEO (requirements WOO-05, MIG-01, MIG-02, MIG-06). WooCommerce 10.5 changed category permalink behavior which may alter product URLs. This plan ensures zero broken product links and validates the complete product display system.

Output: Product URL inventory verified, redirects configured for any changes, all Phase 3 success criteria validated.
</objective>

<execution_context>
@/Users/salesup/.claude/get-shit-done/workflows/execute-plan.md
@/Users/salesup/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-woocommerce-setup-product-display/03-RESEARCH.md
@.planning/phases/03-woocommerce-setup-product-display/03-01-SUMMARY.md
@.planning/phases/03-woocommerce-setup-product-display/03-02-SUMMARY.md
@wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Product URL inventory, verification, and redirect configuration</name>
  <files>
    wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php
  </files>
  <action>
    **Step 1: Generate product URL inventory**
    Run WP-CLI to get all product URLs:
    ```bash
    npx wp-env run cli wp post list --post_type=product --post_status=publish --fields=ID,post_name,post_title --format=csv > /tmp/product-urls.csv
    ```

    Also get the current permalink structure:
    ```bash
    npx wp-env run cli wp option get permalink_structure
    npx wp-env run cli wp option get woocommerce_permalink_structure
    ```

    And get product count by type:
    ```bash
    npx wp-env run cli wp post list --post_type=product --post_status=publish --format=count
    npx wp-env run cli wp post list --post_type=product_variation --post_status=publish --format=count
    ```

    **Step 2: Verify product URLs resolve correctly**
    Use WP-CLI to check a sample of product URLs (first 10 products) return HTTP 200:
    ```bash
    npx wp-env run cli wp post list --post_type=product --post_status=publish --field=url --format=csv | head -10 | while read url; do
      echo "Testing: $url"
      npx wp-env run cli wp eval "echo wp_remote_retrieve_response_code(wp_remote_get('$url'));"
    done
    ```

    Alternatively, use `wp eval` to get product permalinks and test them:
    ```bash
    npx wp-env run cli wp eval '
    $products = wc_get_products(array("limit" => 20, "status" => "publish"));
    foreach ($products as $product) {
        $url = get_permalink($product->get_id());
        $response = wp_remote_get($url);
        $code = wp_remote_retrieve_response_code($response);
        echo $product->get_id() . " | " . $code . " | " . $url . "\n";
    }
    '
    ```

    **Step 3: Check for URL structure changes**
    Verify the current permalink base matches expected pattern. The database was imported in Phase 1, so URLs should be preserved. But WooCommerce 10.5 may use deep category permalinks.

    Check product permalink settings:
    ```bash
    npx wp-env run cli wp option get woocommerce_permalinks --format=json
    ```

    If the permalink structure has changed (e.g., products are now under deeper category paths), configure redirects.

    **Step 4: Configure redirect handling (if needed)**
    If any product URLs have changed, add a redirect handler to `class-smartvarme-woocommerce.php`:
    - Hook into `template_redirect` at priority 1
    - Check if current request is a 404
    - Try to match the requested URL against known product slugs
    - If match found, redirect to the correct URL with 301 status

    Implementation:
    ```php
    public function handle_product_redirects() {
        if (!is_404()) return;

        $request_uri = $_SERVER['REQUEST_URI'];
        $slug = basename(rtrim($request_uri, '/'));

        // Try to find product by slug
        $product_query = new WP_Query(array(
            'post_type' => 'product',
            'name' => $slug,
            'posts_per_page' => 1,
        ));

        if ($product_query->have_posts()) {
            $product_query->the_post();
            $new_url = get_permalink();
            wp_reset_postdata();
            if ($new_url !== home_url($request_uri)) {
                wp_redirect($new_url, 301);
                exit;
            }
        }
    }
    ```

    This is a safety net that catches any broken product URLs by slug matching.

    **Step 5: Flush rewrite rules**
    After all configuration:
    ```bash
    npx wp-env run cli wp rewrite flush
    ```

    **Step 6: Verify variable products**
    Find products with 10+ variations and verify they load:
    ```bash
    npx wp-env run cli wp eval '
    $products = wc_get_products(array("limit" => -1, "type" => "variable", "status" => "publish"));
    echo "Variable products: " . count($products) . "\n";
    foreach ($products as $product) {
        $variations = $product->get_children();
        $count = count($variations);
        if ($count >= 10) {
            echo $product->get_id() . " | " . $product->get_name() . " | " . $count . " variations\n";
            $url = get_permalink($product->get_id());
            $response = wp_remote_get($url);
            $code = wp_remote_retrieve_response_code($response);
            echo "  URL: $url | HTTP $code\n";
        }
    }
    '
    ```
  </action>
  <verify>
    1. Product URL inventory generated (count of published products matches expected ~794)
    2. Sample of 20 product URLs return HTTP 200
    3. No unexpected 404s for product pages
    4. Permalink structure is documented and consistent
    5. Variable products with 10+ variations load correctly (HTTP 200)
    6. Redirect handler exists in class-smartvarme-woocommerce.php (safety net)
    7. `npx wp-env run cli wp rewrite flush` completes successfully
  </verify>
  <done>
    All product URLs verified accessible. Product URL inventory documented. Redirect safety net configured for any slug-based URL changes. Rewrite rules flushed. Variable products with many variations confirmed loading correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Comprehensive Phase 3 success criteria verification</name>
  <files></files>
  <action>
    Run a comprehensive verification of all Phase 3 success criteria from the ROADMAP. This is a verification-only task (no file modifications).

    **Success Criterion 1: "All products from old site are accessible at their original URLs with correct data"**
    ```bash
    npx wp-env run cli wp eval '
    $total = 0; $ok = 0; $fail = 0;
    $products = wc_get_products(array("limit" => -1, "status" => "publish"));
    $total = count($products);
    foreach ($products as $product) {
        $url = get_permalink($product->get_id());
        $response = wp_remote_get($url);
        $code = wp_remote_retrieve_response_code($response);
        if ($code == 200) $ok++;
        else { $fail++; echo "FAIL: " . $product->get_id() . " | $code | $url\n"; }
    }
    echo "\nResults: $ok/$total OK, $fail failures\n";
    '
    ```

    **Success Criterion 2: "Product custom fields (stock display, delivery time) render correctly on product pages"**
    ```bash
    npx wp-env run cli wp eval '
    // Check that the stock/delivery hook is registered
    global $wp_filter;
    $found = false;
    if (isset($wp_filter["woocommerce_single_product_summary"])) {
        foreach ($wp_filter["woocommerce_single_product_summary"]->callbacks as $priority => $callbacks) {
            foreach ($callbacks as $callback) {
                $func = $callback["function"];
                if (is_array($func)) $func = get_class($func[0]) . "::" . $func[1];
                if (strpos($func, "delivery") !== false || strpos($func, "stock") !== false) {
                    echo "Found hook: $func at priority $priority\n";
                    $found = true;
                }
            }
        }
    }
    echo $found ? "Stock/delivery hook: REGISTERED\n" : "Stock/delivery hook: MISSING\n";
    '
    ```

    **Success Criterion 3: "Product archive pages load with working filtering and sorting"**
    ```bash
    # Test shop page
    npx wp-env run cli wp eval 'echo wp_remote_retrieve_response_code(wp_remote_get(wc_get_page_permalink("shop")));'
    # Test sorting parameter
    npx wp-env run cli wp eval 'echo wp_remote_retrieve_response_code(wp_remote_get(wc_get_page_permalink("shop") . "?orderby=price"));'
    ```

    **Success Criterion 4: "Variable products with 10+ variations display all variations correctly"**
    (Already verified in Task 1, confirm results)

    **Success Criterion 5: "WooCommerce HPOS is enabled"**
    ```bash
    npx wp-env run cli wp option get woocommerce_custom_orders_table_enabled
    npx wp-env run cli wp eval '
    if (class_exists("Automattic\WooCommerce\Utilities\OrderUtil")) {
        echo Automattic\WooCommerce\Utilities\OrderUtil::custom_orders_table_usage_is_enabled() ? "HPOS: ENABLED\n" : "HPOS: DISABLED\n";
    } else {
        echo "OrderUtil class not found\n";
    }
    '
    ```

    **Aggregate results into a verification report:**
    Print a summary table:
    ```
    Phase 3 Verification Results:
    ================================
    1. Product URLs accessible:     [PASS/FAIL] (X/Y products OK)
    2. Custom fields rendering:     [PASS/FAIL]
    3. Archive pages + sorting:     [PASS/FAIL]
    4. Variable products (10+ var): [PASS/FAIL] (X products tested)
    5. HPOS enabled:                [PASS/FAIL]
    ================================
    ```

    If any criteria fail, document the failure reason and affected products/URLs for debugging in a gap closure plan.
  </action>
  <verify>
    1. All 5 Phase 3 success criteria are tested
    2. Verification report is printed to console output
    3. Any failures are documented with specific product IDs and URLs
    4. HPOS confirmed enabled via both wp option and OrderUtil API
  </verify>
  <done>
    All Phase 3 success criteria verified. Verification report shows pass/fail for each criterion. Any failures documented with specific details for gap closure. HPOS confirmed active. Product URLs confirmed accessible. Custom fields confirmed rendering. Archive sorting confirmed working.
  </done>
</task>

</tasks>

<verification>
Phase 3 Plan 03 (final verification):
1. All published products return HTTP 200 at their permalinks
2. No unexpected 404 errors for product pages
3. Redirect safety net is in place for slug-based URL recovery
4. Variable products with 10+ variations load without errors
5. HPOS enabled and verified via OrderUtil API
6. Shop page loads with product grid
7. Sorting dropdown works with Norwegian labels
8. Stock/delivery display hooks registered on single product pages
</verification>

<success_criteria>
- 100% of published products accessible at their URLs (HTTP 200)
- Redirect safety net catches any broken product URLs by slug
- All 5 Phase 3 success criteria from ROADMAP pass verification
- Variable products with many variations confirmed loading
- Verification report generated with pass/fail for each criterion
</success_criteria>

<output>
After completion, create `.planning/phases/03-woocommerce-setup-product-display/03-03-SUMMARY.md`
</output>
