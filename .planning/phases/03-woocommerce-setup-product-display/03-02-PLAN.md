---
phase: 03-woocommerce-setup-product-display
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - wp-content/themes/smartvarme-theme/templates/single-product.html
  - wp-content/themes/smartvarme-theme/templates/archive-product.html
  - wp-content/themes/smartvarme-theme/templates/taxonomy-product_cat.html
  - wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php
  - wp-content/themes/smartvarme-theme/src/style.scss
  - wp-content/themes/smartvarme-theme/woocommerce/single-product/stock-delivery.php
autonomous: true

must_haves:
  truths:
    - "Single product page displays product name, price, images, description, and add-to-cart button"
    - "Single product page shows custom stock display text and delivery time below the price"
    - "Product archive page displays products in a responsive grid with images, titles, and prices"
    - "Product archive page has working sorting dropdown (price, newest, name)"
    - "Product category pages display filtered products with category title"
    - "Variable products display all variations with selectable attributes"
  artifacts:
    - path: "wp-content/themes/smartvarme-theme/templates/single-product.html"
      provides: "Single product page FSE template"
      contains: "woocommerce/product"
    - path: "wp-content/themes/smartvarme-theme/templates/archive-product.html"
      provides: "Product archive/shop page FSE template"
      contains: "woocommerce"
    - path: "wp-content/themes/smartvarme-theme/templates/taxonomy-product_cat.html"
      provides: "Product category page FSE template"
      contains: "woocommerce"
    - path: "wp-content/themes/smartvarme-theme/woocommerce/single-product/stock-delivery.php"
      provides: "Custom stock and delivery time display template part"
      contains: "_delivery_time"
  key_links:
    - from: "wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php"
      to: "woocommerce_single_product_summary hook"
      via: "add_action for stock/delivery display"
      pattern: "woocommerce_single_product_summary.*delivery"
    - from: "wp-content/themes/smartvarme-theme/templates/single-product.html"
      to: "WooCommerce product blocks"
      via: "wp:woocommerce blocks"
      pattern: "woocommerce"
    - from: "wp-content/themes/smartvarme-theme/templates/archive-product.html"
      to: "WooCommerce catalog sorting"
      via: "woocommerce_catalog_orderby filter"
      pattern: "catalog_orderby|sorting"
---

<objective>
Create product display templates for single product pages, archive/shop pages, and category pages with custom stock/delivery display and sorting functionality.

Purpose: Product pages are the core of the e-commerce experience. The single product template must display all product data including custom fields (stock display, delivery time). Archive pages must provide a browsable, sortable product grid. This fulfills WOO-03, WOO-04, and WOO-06.

Output: Three FSE templates (single-product, archive-product, taxonomy-product_cat), custom stock/delivery display via hooks, product sorting with Norwegian labels, responsive product grid styling.
</objective>

<execution_context>
@/Users/salesup/.claude/get-shit-done/workflows/execute-plan.md
@/Users/salesup/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-woocommerce-setup-product-display/03-RESEARCH.md
@.planning/phases/03-woocommerce-setup-product-display/03-01-SUMMARY.md
@wp-content/themes/smartvarme-theme/theme.json
@wp-content/themes/smartvarme-theme/templates/single.html
@wp-content/themes/smartvarme-theme/templates/archive.html
@wp-content/themes/smartvarme-theme/parts/header.html
@wp-content/themes/smartvarme-theme/parts/footer.html
@wp-content/themes/smartvarme-theme/src/style.scss
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create single product template with stock/delivery display</name>
  <files>
    wp-content/themes/smartvarme-theme/templates/single-product.html
    wp-content/themes/smartvarme-theme/woocommerce/single-product/stock-delivery.php
    wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php
    wp-content/themes/smartvarme-theme/src/style.scss
  </files>
  <action>
    **Create single-product.html FSE template:**
    Create a block template at `templates/single-product.html` for WooCommerce single product pages. Structure:
    - Header template part (wp:template-part slug="header")
    - Main content area with constrained width (contentSize from theme.json = 1140px)
    - Use WooCommerce product blocks:
      - wp:woocommerce/product-image-gallery (product images with gallery)
      - wp:post-title (product name, h1)
      - wp:woocommerce/product-price (price display)
      - wp:woocommerce/product-rating (star rating)
      - wp:post-excerpt (short description)
      - wp:woocommerce/add-to-cart-form (add to cart button with quantity)
      - wp:woocommerce/product-meta (SKU, categories, tags)
      - wp:post-content (full product description / long description)
      - wp:woocommerce/related-products (related products grid)
    - Use a wp:columns block with 2 columns for the product layout:
      - Left column (60%): Product image gallery
      - Right column (40%): Title, price, stock/delivery info, excerpt, add-to-cart
    - Below the columns: Full description tabs area and related products
    - Footer template part

    **Create stock/delivery display template part:**
    Create `woocommerce/single-product/stock-delivery.php` in the theme. This renders:
    - Stock status with Norwegian text ("Pa lager" / "Ikke pa lager" / "Pa bestilling")
    - Custom stock display override from `_stock_display_override` meta if set
    - Delivery time from `_delivery_time` meta field (e.g., "Leveringstid: 2-5 virkedager")
    - Styled with a subtle background box, using theme colors

    **Hook stock/delivery into single product page:**
    In `class-smartvarme-woocommerce.php`, add action `woocommerce_single_product_summary` at priority 25 (after price at 10, before excerpt at 20... actually WooCommerce default priorities: title=5, rating=10, price=10, excerpt=20, add_to_cart=30, meta=40, sharing=50). Use priority 15 to place between price and excerpt.

    The callback function `smartvarme_display_stock_delivery()` should:
    1. Get the global $product object
    2. Get `_delivery_time` from post meta
    3. Get stock status from `$product->get_stock_status()`
    4. Get `_stock_display_override` from post meta
    5. Render the stock-delivery.php template from theme's woocommerce directory using `wc_get_template()`

    **Add product page styles to style.scss:**
    Add a `.smartvarme-product` section with:
    - Two-column product layout (responsive: stacks on mobile < 768px)
    - Product gallery: full width of left column
    - Stock/delivery info box: light surface background (#f8f9fa), 1rem padding, rounded corners
    - Delivery time: gold (#f7a720) accent icon or border-left
    - Stock status: green for in-stock, red for out-of-stock
    - Related products: 4-column grid on desktop, 2-column on tablet, 1-column on mobile
    - Product meta info: subtle secondary color text
  </action>
  <verify>
    1. File exists: `templates/single-product.html`
    2. File exists: `woocommerce/single-product/stock-delivery.php`
    3. PHP syntax check passes on stock-delivery.php
    4. PHP syntax check passes on class-smartvarme-woocommerce.php
    5. Grep for `woocommerce_single_product_summary` in class-smartvarme-woocommerce.php confirms hook
    6. Grep for `_delivery_time` in stock-delivery.php confirms delivery time rendering
    7. Theme build succeeds: `cd wp-content/themes/smartvarme-theme && npm run build`
    8. Single product page loads: `npx wp-env run cli wp eval 'echo wp_remote_retrieve_response_code(wp_remote_get("http://localhost:8080/?product=test"));'` (or any existing product URL)
  </verify>
  <done>
    Single product page renders with product image gallery, title, price, stock/delivery info box, short description, add-to-cart form, and related products. Stock status shows Norwegian labels. Delivery time displays when set. Layout is responsive with two columns on desktop, single column on mobile.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create archive and category templates with sorting</name>
  <files>
    wp-content/themes/smartvarme-theme/templates/archive-product.html
    wp-content/themes/smartvarme-theme/templates/taxonomy-product_cat.html
    wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php
    wp-content/themes/smartvarme-theme/src/style.scss
  </files>
  <action>
    **Create archive-product.html FSE template (shop page):**
    Create `templates/archive-product.html` for the main shop/product archive page. Structure:
    - Header template part
    - Page title: "Alle produkter" or dynamic archive title
    - Results count and sorting dropdown row (flexbox, space-between)
    - Product grid using wp:woocommerce/product-collection or wp:query block with:
      - 3-column responsive grid (3 cols desktop, 2 cols tablet, 1 col mobile)
      - Each product card: image (300px height, object-fit: cover), title, price, "Legg i handlekurv" button
      - Equal-height cards (like Phase 1 established: 300px image height)
    - Pagination below the grid
    - Footer template part

    **Create taxonomy-product_cat.html template (category pages):**
    Create `templates/taxonomy-product_cat.html` for product category pages. Structure:
    - Same layout as archive-product.html
    - Category name as page title (wp:query-title)
    - Category description below title (wp:term-description)
    - Same product grid and pagination
    - Can largely duplicate archive-product.html with category-specific header elements

    **Add Norwegian sorting options:**
    In `class-smartvarme-woocommerce.php`, add filter `woocommerce_catalog_orderby` to customize sort options with Norwegian labels:
    - `menu_order` => "Standard sortering"
    - `popularity` => "Sorter etter popularitet"
    - `rating` => "Sorter etter vurdering"
    - `date` => "Sorter etter nyeste"
    - `price` => "Sorter etter pris: lav til hoy"
    - `price-desc` => "Sorter etter pris: hoy til lav"

    Also add a custom sort option for in-stock-first:
    - `stock_status` => "Pa lager forst"

    Hook into `woocommerce_get_catalog_ordering_args` to handle the `stock_status` sort:
    ```php
    if ($orderby_value === 'stock_status') {
        $args['meta_key'] = '_stock_status';
        $args['orderby'] = 'meta_value';
        $args['order'] = 'ASC'; // instock before outofstock alphabetically
    }
    ```

    **Set products per page:**
    Add filter `loop_shop_per_page` returning 12 (4 rows of 3 products).

    **Add archive/grid styles to style.scss:**
    Add a `.smartvarme-shop` section with:
    - Product grid: CSS Grid with `grid-template-columns: repeat(3, 1fr)` on desktop
    - Product card: white background, subtle box-shadow on hover, transition
    - Product image: 300px height, object-fit: cover (consistent with Phase 1)
    - Product title: truncate to 2 lines with line-clamp
    - Price: bold, gold color for sale prices
    - Add to cart button: gold background (#f7a720), white text, matching brand
    - Sorting bar: flex row with results count left, dropdown right
    - Pagination: centered, gold active page indicator
    - Category description: max 3 lines with subtle text
    - Responsive breakpoints: 768px (2 cols), 480px (1 col)
  </action>
  <verify>
    1. File exists: `templates/archive-product.html`
    2. File exists: `templates/taxonomy-product_cat.html`
    3. Grep for `woocommerce_catalog_orderby` in class-smartvarme-woocommerce.php confirms sorting filter
    4. Grep for `loop_shop_per_page` in class-smartvarme-woocommerce.php confirms products per page
    5. Theme build succeeds: `cd wp-content/themes/smartvarme-theme && npm run build`
    6. Shop page loads: `npx wp-env run cli wp eval 'echo wp_remote_retrieve_response_code(wp_remote_get("http://localhost:8080/shop/"));'`
    7. Product count: `npx wp-env run cli wp post list --post_type=product --format=count` shows products exist
  </verify>
  <done>
    Product archive displays a 3-column responsive grid with product cards showing image, title, price, and add-to-cart. Sorting dropdown has Norwegian labels including "Pa lager forst" custom option. Category pages display with category title and description. 12 products per page with pagination. Layout is responsive across breakpoints.
  </done>
</task>

</tasks>

<verification>
Phase 3 Plan 02 verification:
1. Single product page loads at any product URL with product data visible
2. Stock/delivery info box renders on single product pages
3. Shop page loads at /shop/ with product grid
4. Category pages load with filtered products
5. Sorting dropdown shows Norwegian labels
6. Product grid is responsive (check at different viewport widths)
7. Theme build passes without errors
8. All PHP files pass syntax validation
</verification>

<success_criteria>
- Single product page renders complete product data with images, price, description, add-to-cart
- Custom stock display and delivery time render on single product pages below price
- Product archive shows responsive grid with 12 products per page
- Sorting works with Norwegian labels
- Category pages display with category name and description
- Variable products show variation selectors
- All templates use theme header/footer parts
- Theme compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-woocommerce-setup-product-display/03-02-SUMMARY.md`
</output>
