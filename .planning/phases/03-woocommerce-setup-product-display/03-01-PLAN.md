---
phase: 03-woocommerce-setup-product-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - wp-content/plugins/smartvarme-core/smartvarme-core.php
  - wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php
  - wp-content/plugins/smartvarme-core/includes/class-smartvarme-core.php
autonomous: true

must_haves:
  truths:
    - "WooCommerce HPOS is enabled and orders use custom tables (wp_wc_orders)"
    - "Smartvarme Core plugin declares HPOS compatibility"
    - "Product attributes pa_effekt and pa_energiklasse exist as WooCommerce taxonomies"
    - "Product meta field _effekt_kw is populated for products with power ratings"
  artifacts:
    - path: "wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php"
      provides: "HPOS compatibility declaration, product attribute registration, custom field handling"
      contains: "declare_compatibility"
  key_links:
    - from: "wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php"
      to: "WooCommerce HPOS API"
      via: "FeaturesUtil::declare_compatibility"
      pattern: "declare_compatibility.*custom_order_tables"
    - from: "wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php"
      to: "WooCommerce product attributes"
      via: "register_taxonomy"
      pattern: "pa_effekt|pa_energiklasse"
---

<objective>
Enable WooCommerce High Performance Order Storage (HPOS) and configure product data infrastructure including custom attributes and metadata fields.

Purpose: HPOS provides 5x faster order creation and 40x faster lookups. Product attributes (pa_effekt, pa_energiklasse) and metadata (_effekt_kw) are required by the energy calculator block from Phase 2 and for product filtering in later plans.

Output: HPOS enabled in compatibility mode, plugin declares HPOS compatibility, product attributes registered, product metadata populated for existing products.
</objective>

<execution_context>
@/Users/salesup/.claude/get-shit-done/workflows/execute-plan.md
@/Users/salesup/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-woocommerce-setup-product-display/03-RESEARCH.md
@.planning/phases/02-content-system-migration/02-04-SUMMARY.md
@wp-content/plugins/smartvarme-core/smartvarme-core.php
@wp-content/plugins/smartvarme-core/includes/class-smartvarme-core.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable HPOS and declare plugin compatibility</name>
  <files>
    wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php
    wp-content/plugins/smartvarme-core/includes/class-smartvarme-core.php
    wp-content/plugins/smartvarme-core/smartvarme-core.php
  </files>
  <action>
    Create `class-smartvarme-woocommerce.php` in the plugin includes directory. This class handles all WooCommerce-specific customizations for the Smartvarme plugin.

    **HPOS Compatibility Declaration:**
    Add a `before_woocommerce_init` hook that calls `FeaturesUtil::declare_compatibility('custom_order_tables', SMARTVARME_CORE_PATH . 'smartvarme-core.php', true)`. This tells WooCommerce our plugin is HPOS-compatible. Use the pattern from research (Pattern 1): check `class_exists(\Automattic\WooCommerce\Utilities\FeaturesUtil::class)` before calling.

    **Enable HPOS via WP-CLI:**
    Run the following WP-CLI commands inside the Docker container:
    ```bash
    npx wp-env run cli wp option update woocommerce_custom_orders_table_enabled yes
    npx wp-env run cli wp option update woocommerce_custom_orders_table_data_sync_enabled yes
    ```
    The first enables HPOS custom tables, the second enables compatibility mode (syncs orders to both tables for rollback safety).

    **Wire into plugin:**
    In `class-smartvarme-core.php`, require and instantiate the new WooCommerce class. Add a method `load_woocommerce_integration()` that requires the file and creates an instance, called from the `run()` method. Only load if WooCommerce is active (check `class_exists('WooCommerce')`).

    **Verify HPOS is active:**
    Run: `npx wp-env run cli wp option get woocommerce_custom_orders_table_enabled`
    Expected output: `yes`
  </action>
  <verify>
    1. `npx wp-env run cli wp option get woocommerce_custom_orders_table_enabled` returns `yes`
    2. `npx wp-env run cli wp option get woocommerce_custom_orders_table_data_sync_enabled` returns `yes`
    3. `php -l wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php` returns no errors
    4. Grep for `declare_compatibility` in the new file confirms HPOS compatibility declaration exists
  </verify>
  <done>
    WooCommerce HPOS is enabled with compatibility mode. Smartvarme Core plugin declares HPOS compatibility. Plugin loads WooCommerce integration only when WooCommerce is active.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register product attributes and populate product metadata</name>
  <files>
    wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php
  </files>
  <action>
    **Register WooCommerce product attributes:**
    In the `class-smartvarme-woocommerce.php` class, add an `init` hook method that registers two product attributes using the WooCommerce attribute API:

    1. `pa_effekt` (Effekt) - Power rating in kW. Register via `wc_create_attribute()` with name "Effekt", slug "pa_effekt", type "select", order_by "menu_order". If it already exists (returns WP_Error with code "duplicate"), skip silently.
    2. `pa_energiklasse` (Energiklasse) - Energy class rating. Register via `wc_create_attribute()` with name "Energiklasse", slug "pa_energiklasse", type "select", order_by "menu_order". Same duplicate handling.

    Register the corresponding taxonomies using `register_taxonomy()` for `pa_effekt` and `pa_energiklasse` with `object_type` of `product`. Set `show_in_rest` to true for Gutenberg compatibility.

    **Add custom product fields to admin:**
    Hook into `woocommerce_product_options_general_product_data` to add:
    - `_effekt_kw` text input field (label: "Effekt (kW)", placeholder: "f.eks. 6.5", description: "Effektbehov i kW for energikalkulator")
    - `_delivery_time` text input field (label: "Leveringstid", placeholder: "f.eks. 2-5 virkedager", description: "Forventet leveringstid")

    Hook into `woocommerce_process_product_meta` to save both fields using `update_post_meta()` with proper `sanitize_text_field()`.

    **Populate _effekt_kw for existing products:**
    Run a WP-CLI command to query products that have the `pa_effekt` attribute term assigned and extract numeric kW value into `_effekt_kw` post meta. Use:
    ```bash
    npx wp-env run cli wp eval '
    $products = wc_get_products(array("limit" => -1, "status" => "publish"));
    $updated = 0;
    foreach ($products as $product) {
        $attrs = $product->get_attributes();
        if (isset($attrs["pa_effekt"])) {
            $terms = wp_get_post_terms($product->get_id(), "pa_effekt");
            if (!empty($terms) && !is_wp_error($terms)) {
                $kw = preg_replace("/[^0-9.,]/", "", $terms[0]->name);
                $kw = str_replace(",", ".", $kw);
                if ($kw) {
                    update_post_meta($product->get_id(), "_effekt_kw", floatval($kw));
                    $updated++;
                }
            }
        }
    }
    echo "Updated _effekt_kw for $updated products\n";
    '
    ```

    Note: If no products have pa_effekt yet (attributes may not have been assigned in old data), the script will update 0 products which is fine. The field infrastructure is what matters; data will be populated as products are edited.
  </action>
  <verify>
    1. `npx wp-env run cli wp eval 'echo wc_attribute_taxonomy_name("effekt");'` outputs `pa_effekt`
    2. `npx wp-env run cli wp eval 'echo wc_attribute_taxonomy_name("energiklasse");'` outputs `pa_energiklasse`
    3. Grep for `_effekt_kw` and `_delivery_time` in class-smartvarme-woocommerce.php confirms custom fields are registered
    4. `npx wp-env run cli wp eval 'echo taxonomy_exists("pa_effekt") ? "yes" : "no";'` returns `yes`
    5. PHP syntax check passes on the modified file
  </verify>
  <done>
    Product attributes pa_effekt and pa_energiklasse are registered as WooCommerce taxonomies. Custom product fields (_effekt_kw, _delivery_time) appear in product edit screens. Existing products with pa_effekt attribute have _effekt_kw meta populated with numeric values.
  </done>
</task>

</tasks>

<verification>
Phase 3 Plan 01 verification:
1. HPOS enabled: `npx wp-env run cli wp option get woocommerce_custom_orders_table_enabled` returns `yes`
2. Compatibility mode: `npx wp-env run cli wp option get woocommerce_custom_orders_table_data_sync_enabled` returns `yes`
3. Plugin compatibility: grep confirms `declare_compatibility` in class-smartvarme-woocommerce.php
4. Attributes exist: `npx wp-env run cli wp eval 'echo taxonomy_exists("pa_effekt") ? "yes" : "no";'`
5. Custom fields exist: grep confirms `_effekt_kw` and `_delivery_time` in woocommerce class
6. All PHP files pass syntax check
</verification>

<success_criteria>
- WooCommerce HPOS is enabled with compatibility mode (dual table sync)
- Smartvarme Core plugin declares HPOS compatibility with `FeaturesUtil::declare_compatibility`
- Product attributes pa_effekt and pa_energiklasse exist as WooCommerce taxonomies
- Custom product fields (_effekt_kw, _delivery_time) are editable in product admin
- All PHP passes syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/03-woocommerce-setup-product-display/03-01-SUMMARY.md`
</output>
