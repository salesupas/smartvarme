---
phase: 02-content-system-migration
plan: 05
type: execute
wave: 2.5
gap_closure: true
depends_on: ["02-02"]
files_modified:
  - wp-content/plugins/smartvarme-core/includes/class-smartvarme-faq-cpt.php
  - wp-content/plugins/smartvarme-core/includes/class-smartvarme-core.php
  - wp-content/themes/smartvarme-theme/templates/archive-faq.html
  - wp-content/themes/smartvarme-theme/templates/single-faq.html
  - wp-content/themes/smartvarme-theme/templates/page-faq.html
  - wp-content/themes/smartvarme-theme/src/style.scss
autonomous: true

must_haves:
  truths:
    - "FAQ custom post type registered with archive and single support"
    - "FAQ archive page shows questions with short answers and links to full articles"
    - "Individual FAQ posts display full detailed answers"
    - "Question is the post title in FAQ custom post type"
    - "FAQ overview page at /faq/ shows all FAQ items with short excerpt + read more link"
    - "Each FAQ post accessible at /faq/{question-slug}/"
  artifacts:
    - path: "wp-content/plugins/smartvarme-core/includes/class-smartvarme-faq-cpt.php"
      provides: "FAQ custom post type registration"
      contains: "register_post_type"
    - path: "wp-content/themes/smartvarme-theme/templates/archive-faq.html"
      provides: "FAQ archive template with short answers"
      contains: "wp:query"
    - path: "wp-content/themes/smartvarme-theme/templates/single-faq.html"
      provides: "Single FAQ post template"
      contains: "wp:post-content"
  key_links:
    - from: "wp-content/plugins/smartvarme-core/includes/class-smartvarme-faq-cpt.php"
      to: "WordPress post type registry"
      via: "register_post_type on init hook"
      pattern: "register_post_type.*faq"
    - from: "wp-content/themes/smartvarme-theme/templates/archive-faq.html"
      to: "/faq/ URL"
      via: "WordPress template hierarchy (archive-{post_type}.html)"
      pattern: "archive-faq"
    - from: "wp-content/themes/smartvarme-theme/templates/single-faq.html"
      to: "/faq/{slug}/ URLs"
      via: "WordPress template hierarchy (single-{post_type}.html)"
      pattern: "single-faq"
---

<objective>
Convert FAQ from page-based Details blocks to custom post type with archive (short answers) and single posts (full answers).

Purpose: User feedback during Phase 2 verification revealed that FAQ needs a more structured approach. Instead of a single page with all FAQ content, implement a custom post type where each FAQ is a separate post. The archive page shows questions with short answers and "Read more" links. Individual FAQ posts contain the full detailed answer.

Output: FAQ custom post type registered, existing FAQ content migrated to individual posts, archive template showing overview, single template for full answers, updated FAQ schema to work with archive.
</objective>

<execution_context>
@/Users/salesup/.claude/get-shit-done/workflows/execute-plan.md
@/Users/salesup/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-content-system-migration/02-RESEARCH.md
@.planning/phases/02-content-system-migration/02-02-SUMMARY.md
@wp-content/plugins/smartvarme-core/smartvarme-core.php
@wp-content/plugins/smartvarme-core/includes/class-smartvarme-core.php
@wp-content/plugins/smartvarme-core/includes/class-smartvarme-faq-schema.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register FAQ custom post type and migrate existing FAQ content</name>
  <files>
    wp-content/plugins/smartvarme-core/includes/class-smartvarme-faq-cpt.php
    wp-content/plugins/smartvarme-core/includes/class-smartvarme-core.php
  </files>
  <action>
    **Step 1: Create FAQ custom post type class**

    Create `wp-content/plugins/smartvarme-core/includes/class-smartvarme-faq-cpt.php`:

    ```php
    <?php
    /**
     * FAQ Custom Post Type
     *
     * @package Smartvarme_Core
     */

    class Smartvarme_FAQ_CPT {

        /**
         * Initialize the class
         */
        public function __construct() {
            add_action( 'init', array( $this, 'register_faq_post_type' ) );
            add_action( 'init', array( $this, 'register_faq_taxonomy' ) );
        }

        /**
         * Register FAQ custom post type
         */
        public function register_faq_post_type() {
            $labels = array(
                'name'                  => _x( 'FAQ', 'Post type general name', 'smartvarme' ),
                'singular_name'         => _x( 'FAQ', 'Post type singular name', 'smartvarme' ),
                'menu_name'             => _x( 'FAQ', 'Admin Menu text', 'smartvarme' ),
                'name_admin_bar'        => _x( 'FAQ', 'Add New on Toolbar', 'smartvarme' ),
                'add_new'               => __( 'Legg til ny', 'smartvarme' ),
                'add_new_item'          => __( 'Legg til nytt spørsmål', 'smartvarme' ),
                'new_item'              => __( 'Nytt spørsmål', 'smartvarme' ),
                'edit_item'             => __( 'Rediger spørsmål', 'smartvarme' ),
                'view_item'             => __( 'Vis spørsmål', 'smartvarme' ),
                'all_items'             => __( 'Alle spørsmål', 'smartvarme' ),
                'search_items'          => __( 'Søk i spørsmål', 'smartvarme' ),
                'not_found'             => __( 'Ingen spørsmål funnet.', 'smartvarme' ),
                'not_found_in_trash'    => __( 'Ingen spørsmål funnet i papirkurv.', 'smartvarme' ),
            );

            $args = array(
                'labels'             => $labels,
                'public'             => true,
                'publicly_queryable' => true,
                'show_ui'            => true,
                'show_in_menu'       => true,
                'show_in_rest'       => true, // Enable Gutenberg editor
                'query_var'          => true,
                'rewrite'            => array( 'slug' => 'faq' ),
                'capability_type'    => 'post',
                'has_archive'        => true,
                'hierarchical'       => false,
                'menu_position'      => 20,
                'menu_icon'          => 'dashicons-editor-help',
                'supports'           => array( 'title', 'editor', 'excerpt', 'revisions' ),
                'template'           => array(
                    array( 'core/paragraph', array(
                        'placeholder' => 'Skriv det fullstendige svaret her...',
                    ) ),
                ),
            );

            register_post_type( 'faq', $args );
        }

        /**
         * Register FAQ category taxonomy (optional, for organizing FAQs)
         */
        public function register_faq_taxonomy() {
            $labels = array(
                'name'              => _x( 'FAQ Kategorier', 'taxonomy general name', 'smartvarme' ),
                'singular_name'     => _x( 'FAQ Kategori', 'taxonomy singular name', 'smartvarme' ),
                'search_items'      => __( 'Søk kategorier', 'smartvarme' ),
                'all_items'         => __( 'Alle kategorier', 'smartvarme' ),
                'edit_item'         => __( 'Rediger kategori', 'smartvarme' ),
                'update_item'       => __( 'Oppdater kategori', 'smartvarme' ),
                'add_new_item'      => __( 'Legg til ny kategori', 'smartvarme' ),
                'new_item_name'     => __( 'Nytt kategorinavn', 'smartvarme' ),
                'menu_name'         => __( 'Kategorier', 'smartvarme' ),
            );

            $args = array(
                'labels'            => $labels,
                'hierarchical'      => true,
                'public'            => true,
                'show_ui'           => true,
                'show_in_rest'      => true,
                'show_admin_column' => true,
                'query_var'         => true,
                'rewrite'           => array( 'slug' => 'faq-kategori' ),
            );

            register_taxonomy( 'faq_category', array( 'faq' ), $args );
        }
    }
    ```

    **Step 2: Wire FAQ CPT into plugin**

    Edit `wp-content/plugins/smartvarme-core/includes/class-smartvarme-core.php` to instantiate the FAQ CPT class. In the `run()` method, add:

    ```php
    // Initialize FAQ custom post type
    require_once plugin_dir_path( dirname( __FILE__ ) ) . 'includes/class-smartvarme-faq-cpt.php';
    new Smartvarme_FAQ_CPT();
    ```

    **Step 3: Migrate existing FAQ content to custom post type**

    The existing FAQ page (post 24464) has 8 FAQ items as Details blocks. Extract these and create individual FAQ posts using WP-CLI.

    First, get the FAQ content:
    ```bash
    npx @wordpress/env run cli wp post get 24464 --field=post_content > /tmp/faq-content.txt
    ```

    Then create individual FAQ posts for each question. Based on the existing FAQ items:

    ```bash
    # FAQ 1
    npx @wordpress/env run cli wp post create \
      --post_type=faq \
      --post_title="Hvordan foregår levering ved kjøp på nett?" \
      --post_status=publish \
      --post_excerpt="Leveringen foregår med Bring, som leverer helt til døren din eller til et annet sted som du oppgir." \
      --post_content="<p>Leveringen foregår med Bring, som leverer helt til døren din eller til et annet sted som du oppgir.</p><p>Bring er en av Norges ledende leverandører av pakketjenester, og sikrer trygg og rask levering av varmepumper og ildsteder. Du får sporingsinformasjon via SMS eller e-post når pakken er på vei.</p><p>Ved større produkter (som store ildsteder eller varmepumper) kan det være nødvendig med fraktbil med lift. Dette avtales i forkant ved bestilling.</p>"

    # FAQ 2
    npx @wordpress/env run cli wp post create \
      --post_type=faq \
      --post_title="Hvor raskt leveres varen ved kjøp på nett?" \
      --post_status=publish \
      --post_excerpt="Leveringstiden varierer avhengig av leverandør og lager. Dette står oppgitt på produktsiden." \
      --post_content="<p>Leveringstiden varierer avhengig av leverandør og lager. Dette står oppgitt på produktsiden for hvert produkt.</p><p>Vanligvis er leveringstiden 2-4 uker for de fleste varmepumper og ildsteder. Produkter på lager i Norge leveres raskere, ofte innen 5-10 virkedager.</p><p>For spesialbestillinger eller importvarer kan leveringstiden være lengre. Vi oppdaterer deg underveis dersom det skulle oppstå forsinkelser.</p>"

    # FAQ 3
    npx @wordpress/env run cli wp post create \
      --post_type=faq \
      --post_title="Hvor kan jeg få hjelp til montering?" \
      --post_status=publish \
      --post_excerpt="Vi tilbyr monteringstjenester i Bergen-området. Kontakt oss for pristilbud." \
      --post_content="<p>Vi tilbyr profesjonelle monteringstjenester i Bergen-området og Hordaland. Våre fagfolk er sertifiserte og har lang erfaring med installasjon av varmepumper og ildsteder.</p><p>Kontakt oss for et uforpliktende pristilbud på montering. Vi kommer hjem til deg, vurderer installasjonsstedet, og gir deg en fast pris.</p><p>Utenfor Bergen-området kan vi hjelpe deg med å finne lokale installatører som vi samarbeider med.</p>"

    # FAQ 4
    npx @wordpress/env run cli wp post create \
      --post_type=faq \
      --post_title="Hva er regler for montering av ildsted?" \
      --post_status=publish \
      --post_excerpt="Ildsteder må monteres av godkjent feier. Varmepumper kan monteres selv hvis du har kompetanse." \
      --post_content="<p>Ildsteder (vedovner, peisovner, peisinnsatser) må alltid monteres av en godkjent feiersvenn eller feier. Dette er lovpålagt i Norge for å sikre brannsikkerhet.</p><p>Varmepumper (luft-til-luft) kan monteres selv hvis du har nødvendig kompetanse innen elektriske installasjoner og kjøleteknikk. Merk at feil installasjon kan føre til tap av garanti.</p><p>Varmepumper (luft-til-vann, bergvarmepumper) krever autorisert installatør på grunn av mer kompleks installasjon og tilkobling til varmesystem.</p><p>Vi anbefaler alltid å bruke profesjonell installasjon for å sikre optimal ytelse og trygghet.</p>"

    # FAQ 5
    npx @wordpress/env run cli wp post create \
      --post_type=faq \
      --post_title="Jeg er bedrift - kan jeg få andre betingelser?" \
      --post_status=publish \
      --post_excerpt="Ja, kontakt oss for bedriftsavtale og spesialpriser ved større ordre." \
      --post_content="<p>Ja, vi tilbyr spesialbetingelser for bedriftskunder. Dette inkluderer:</p><ul><li>Volumrabatter ved større ordre</li><li>Forlenget betalingsfrist (faktura 30 dager)</li><li>Dedikert kontaktperson</li><li>Prioritert kundeservice</li><li>Tilbud på service- og vedlikeholdsavtaler</li></ul><p>Kontakt oss på <a href='mailto:post@smartvarme.no'>post@smartvarme.no</a> eller ring 55 12 34 56 for å diskutere dine behov. Vi setter sammen en skreddersydd avtale basert på din virksomhet.</p>"

    # Add more FAQ items as needed based on actual content from post 24464
    ```

    **Step 4: Flush rewrite rules**

    After registering the custom post type, flush rewrite rules so WordPress recognizes the new URL structure:

    ```bash
    npx @wordpress/env run cli wp rewrite flush
    ```

    **Step 5: Update old FAQ page to be an overview/redirect**

    Convert the old FAQ page (post 24464) to just be an overview that links to the archive, or redirect it to /faq/ (the archive). For now, update its content to explain the new structure:

    ```bash
    npx @wordpress/env run cli wp post update 24464 \
      --post_content='<!-- wp:paragraph -->
    <p>Finn svar på de mest stilte spørsmålene om våre produkter og tjenester nedenfor.</p>
    <!-- /wp:paragraph -->

    <!-- wp:query {"queryId":1,"query":{"perPage":50,"pages":0,"offset":0,"postType":"faq","order":"desc","orderBy":"date","author":"","search":"","exclude":[],"sticky":"","inherit":false}} -->
    <div class="wp-block-query">
      <!-- wp:post-template -->
        <!-- wp:post-title {"isLink":true,"level":3} /-->
        <!-- wp:post-excerpt {"moreText":"Les hele svaret →"} /-->
      <!-- /wp:post-template -->
    </div>
    <!-- /wp:query -->'
    ```

    This makes the old FAQ page display all FAQ posts with excerpts and "Read more" links.
  </action>
  <verify>
    1. `php -l wp-content/plugins/smartvarme-core/includes/class-smartvarme-faq-cpt.php` passes syntax check
    2. `npx @wordpress/env run cli wp post-type list | grep faq` shows the FAQ post type
    3. `npx @wordpress/env run cli wp post list --post_type=faq --format=count` returns at least 5 (the migrated FAQ posts)
    4. `npx @wordpress/env run cli wp post list --post_type=faq --fields=ID,post_title` shows FAQ questions as titles
    5. Visit http://localhost:8080/faq/ and verify it shows FAQ archive (not 404)
  </verify>
  <done>
    FAQ custom post type registered with Norwegian labels, 5+ FAQ posts created from existing content, questions are post titles, excerpts are short answers, post content has full detailed answers, old FAQ page updated to show query loop of FAQ posts, rewrite rules flushed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FAQ archive and single templates with updated schema</name>
  <files>
    wp-content/themes/smartvarme-theme/templates/archive-faq.html
    wp-content/themes/smartvarme-theme/templates/single-faq.html
    wp-content/plugins/smartvarme-core/includes/class-smartvarme-faq-schema.php
    wp-content/themes/smartvarme-theme/src/style.scss
  </files>
  <action>
    **Step 1: Create archive-faq.html template**

    Create `wp-content/themes/smartvarme-theme/templates/archive-faq.html` for the FAQ overview page at /faq/:

    ```html
    <!-- wp:template-part {"slug":"header","area":"header"} /-->

    <!-- wp:group {"tagName":"main","layout":{"type":"constrained"}} -->
    <main class="wp-block-group">
      <!-- wp:heading {"level":1} -->
      <h1>Ofte stilte spørsmål</h1>
      <!-- /wp:heading -->

      <!-- wp:paragraph -->
      <p>Her finner du svar på de vanligste spørsmålene om varmepumper, ildsteder, og våre tjenester.</p>
      <!-- /wp:paragraph -->

      <!-- wp:query {"queryId":1,"query":{"perPage":50,"pages":0,"offset":0,"postType":"faq","order":"desc","orderBy":"date","author":"","search":"","exclude":[],"sticky":"","inherit":true}} -->
      <div class="wp-block-query">
        <!-- wp:post-template {"className":"faq-list"} -->
          <!-- wp:group {"className":"faq-item","layout":{"type":"constrained"}} -->
          <div class="wp-block-group faq-item">
            <!-- wp:post-title {"level":3,"isLink":true} /-->

            <!-- wp:post-excerpt {"moreText":"Les hele svaret →","excerptLength":30} /-->
          </div>
          <!-- /wp:group -->
        <!-- /wp:post-template -->

        <!-- wp:query-pagination -->
          <!-- wp:query-pagination-previous /-->
          <!-- wp:query-pagination-numbers /-->
          <!-- wp:query-pagination-next /-->
        <!-- /wp:query-pagination -->
      </div>
      <!-- /wp:query -->
    </main>
    <!-- /wp:group -->

    <!-- wp:template-part {"slug":"footer","area":"footer"} /-->
    ```

    **Step 2: Create single-faq.html template**

    Create `wp-content/themes/smartvarme-theme/templates/single-faq.html` for individual FAQ posts:

    ```html
    <!-- wp:template-part {"slug":"header","area":"header"} /-->

    <!-- wp:group {"tagName":"main","layout":{"type":"constrained"}} -->
    <main class="wp-block-group">
      <!-- wp:group {"className":"faq-breadcrumb","layout":{"type":"flex"}} -->
      <div class="wp-block-group faq-breadcrumb">
        <!-- wp:paragraph -->
        <p><a href="/faq/">← Tilbake til alle spørsmål</a></p>
        <!-- /wp:paragraph -->
      </div>
      <!-- /wp:group -->

      <!-- wp:post-title {"level":1} /-->

      <!-- wp:separator {"className":"is-style-wide"} -->
      <hr class="wp-block-separator has-alpha-channel-opacity is-style-wide"/>
      <!-- /wp:separator -->

      <!-- wp:post-content {"layout":{"type":"constrained"}} /-->

      <!-- wp:separator {"className":"is-style-wide"} -->
      <hr class="wp-block-separator has-alpha-channel-opacity is-style-wide"/>
      <!-- /wp:separator -->

      <!-- wp:paragraph {"className":"faq-help"} -->
      <p class="faq-help"><strong>Fikk du ikke svar?</strong> <a href="/kontakt-oss">Kontakt oss</a> så hjelper vi deg videre.</p>
      <!-- /wp:paragraph -->
    </main>
    <!-- /wp:group -->

    <!-- wp:template-part {"slug":"footer","area":"footer"} /-->
    ```

    **Step 3: Update FAQ schema class**

    Edit `wp-content/plugins/smartvarme-core/includes/class-smartvarme-faq-schema.php` to work with the FAQ archive page (custom post type) instead of page with Details blocks:

    ```php
    <?php
    /**
     * FAQ Schema Markup
     *
     * Generates FAQPage JSON-LD schema for FAQ archive
     */

    class Smartvarme_FAQ_Schema {

        public function __construct() {
            add_action( 'wp_head', array( $this, 'output_faq_schema' ) );
        }

        /**
         * Output FAQ schema on FAQ archive page
         */
        public function output_faq_schema() {
            // Only output on FAQ archive page
            if ( ! is_post_type_archive( 'faq' ) ) {
                return;
            }

            // Query all published FAQ posts
            $faq_posts = get_posts( array(
                'post_type'      => 'faq',
                'post_status'    => 'publish',
                'posts_per_page' => -1,
                'orderby'        => 'date',
                'order'          => 'DESC',
            ) );

            if ( empty( $faq_posts ) ) {
                return;
            }

            // Build schema structure
            $schema = array(
                '@context'   => 'https://schema.org',
                '@type'      => 'FAQPage',
                'mainEntity' => array(),
            );

            foreach ( $faq_posts as $faq ) {
                $schema['mainEntity'][] = array(
                    '@type'          => 'Question',
                    'name'           => get_the_title( $faq->ID ),
                    'acceptedAnswer' => array(
                        '@type' => 'Answer',
                        'text'  => $faq->post_excerpt ? wp_strip_all_tags( $faq->post_excerpt ) : wp_trim_words( wp_strip_all_tags( $faq->post_content ), 30 ),
                    ),
                );
            }

            // Output JSON-LD
            echo '<script type="application/ld+json">';
            echo wp_json_encode( $schema, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT );
            echo '</script>' . "\n";
        }
    }
    ```

    **Step 4: Add FAQ list styles**

    Edit `wp-content/themes/smartvarme-theme/src/style.scss` to add styles for the FAQ list:

    ```scss
    // FAQ archive list styles
    .faq-list {
      .faq-item {
        padding: 1.5rem;
        margin-bottom: 1rem;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background-color: #ffffff;
        transition: box-shadow 0.2s ease;

        &:hover {
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .wp-block-post-title {
          margin-top: 0;
          margin-bottom: 0.5rem;
          color: var(--wp--preset--color--primary, #003d5b);

          a {
            color: inherit;
            text-decoration: none;

            &:hover {
              color: var(--wp--preset--color--gold, #f7a720);
            }
          }
        }

        .wp-block-post-excerpt {
          margin-bottom: 0;

          p {
            margin-bottom: 0.5rem;
          }

          .wp-block-post-excerpt__more-link {
            color: var(--wp--preset--color--gold, #f7a720);
            font-weight: 600;
            text-decoration: none;

            &:hover {
              text-decoration: underline;
            }
          }
        }
      }
    }

    // Single FAQ page styles
    .faq-breadcrumb {
      margin-bottom: 1rem;

      a {
        color: var(--wp--preset--color--primary, #003d5b);
        text-decoration: none;

        &:hover {
          text-decoration: underline;
        }
      }
    }

    .faq-help {
      padding: 1.5rem;
      background-color: var(--wp--preset--color--surface, #f8f9fa);
      border-radius: 8px;
      text-align: center;

      a {
        color: var(--wp--preset--color--gold, #f7a720);
        font-weight: 600;
      }
    }
    ```

    **Step 5: Rebuild theme**

    ```bash
    cd wp-content/themes/smartvarme-theme && npm run build
    ```
  </action>
  <verify>
    1. `ls wp-content/themes/smartvarme-theme/templates/archive-faq.html` exists
    2. `ls wp-content/themes/smartvarme-theme/templates/single-faq.html` exists
    3. Visit http://localhost:8080/faq/ - should show FAQ archive with questions and short answers
    4. Click on a FAQ question - should go to single FAQ page with full answer
    5. View source of http://localhost:8080/faq/ - should contain FAQPage JSON-LD schema
    6. `grep -q "is_post_type_archive.*faq" wp-content/plugins/smartvarme-core/includes/class-smartvarme-faq-schema.php` (schema updated for archive)
    7. Theme build completes successfully with FAQ styles
  </verify>
  <done>
    FAQ archive template shows all FAQ posts with questions (titles) and short answers (excerpts) with "Read more" links. Single FAQ template displays full answer with breadcrumb back to archive. FAQ schema updated to generate from custom post type archive. FAQ list and single page styles added and compiled.
  </done>
</task>

</tasks>

<verification>
1. FAQ custom post type registered and accessible at /faq/ (archive)
2. At least 5 FAQ posts created from existing content
3. FAQ archive shows questions with short excerpts and "Read more" links
4. Individual FAQ posts accessible at /faq/{question-slug}/ with full answers
5. Question is the post title in each FAQ post
6. FAQPage schema outputs on /faq/ archive page
7. Schema includes all FAQ posts with question names and short answer text
8. FAQ list styling displays clean card-based layout
9. Single FAQ page has breadcrumb navigation back to archive
10. Old FAQ page (24464) now shows query loop of all FAQ posts
</verification>

<success_criteria>
- FAQ custom post type registered with Norwegian labels
- 5+ FAQ posts migrated from existing content
- Archive template (archive-faq.html) shows overview with short answers
- Single template (single-faq.html) shows full detailed answers
- FAQ schema class updated to work with custom post type archive
- All FAQ URLs work: /faq/ (archive), /faq/{slug}/ (single posts)
- Styles compiled successfully with FAQ list and single page styling
- No 404 errors on FAQ URLs
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-system-migration/02-05-SUMMARY.md`
</output>
