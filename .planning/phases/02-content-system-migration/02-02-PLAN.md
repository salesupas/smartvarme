---
phase: 02-content-system-migration
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - wp-content/themes/smartvarme-theme/templates/single.html
  - wp-content/themes/smartvarme-theme/templates/page-faq.html
  - wp-content/themes/smartvarme-theme/templates/archive.html
  - wp-content/themes/smartvarme-theme/src/style.scss
  - wp-content/plugins/smartvarme-core/includes/class-smartvarme-faq-schema.php
  - wp-content/plugins/smartvarme-core/smartvarme-core.php
  - wp-content/plugins/smartvarme-core/includes/class-smartvarme-core.php
autonomous: true

must_haves:
  truths:
    - "FAQ page at /faq/ displays all 6 FAQ items in native accordion format (not Kadence blocks)"
    - "FAQ page outputs FAQPage schema JSON-LD in page head"
    - "Blog posts display with featured image, title, author, date, and content"
    - "Blog archive page shows posts in a readable card layout"
    - "Accordion items expand/collapse on click"
  artifacts:
    - path: "wp-content/themes/smartvarme-theme/templates/single.html"
      provides: "Enhanced single post template with featured image and metadata"
      contains: "wp:post-featured-image"
    - path: "wp-content/themes/smartvarme-theme/templates/page-faq.html"
      provides: "Custom FAQ page template"
      contains: "wp:post-content"
    - path: "wp-content/themes/smartvarme-theme/templates/archive.html"
      provides: "Enhanced archive template with card layout"
      contains: "wp:query"
    - path: "wp-content/plugins/smartvarme-core/includes/class-smartvarme-faq-schema.php"
      provides: "FAQ schema markup generator"
      contains: "FAQPage"
    - path: "wp-content/themes/smartvarme-theme/src/style.scss"
      provides: "Styles for accordion, blog cards, and content layout"
      contains: "wp-block-details"
  key_links:
    - from: "wp-content/plugins/smartvarme-core/includes/class-smartvarme-faq-schema.php"
      to: "wp_head action"
      via: "add_action hook to inject JSON-LD"
      pattern: "add_action.*wp_head"
    - from: "wp-content/plugins/smartvarme-core/smartvarme-core.php"
      to: "class-smartvarme-faq-schema.php"
      via: "require_once in plugin initialization"
      pattern: "require_once.*faq-schema"
    - from: "wp-content/themes/smartvarme-theme/templates/page-faq.html"
      to: "FAQ page (ID 24464, slug: faq)"
      via: "WordPress template hierarchy (page-{slug}.html)"
      pattern: "page-faq"
---

<objective>
Migrate FAQ content from Kadence accordion to native WordPress blocks, add FAQ schema markup, and enhance blog templates.

Purpose: The existing FAQ page uses Kadence Accordion blocks which create a third-party dependency. Converting to native WordPress Details blocks removes this dependency and enables FAQ schema markup. Enhanced blog templates provide a proper reading experience.

Output: FAQ page with native accordions and JSON-LD schema, enhanced single post and archive templates, content styling.
</objective>

<execution_context>
@/Users/salesup/.claude/get-shit-done/workflows/execute-plan.md
@/Users/salesup/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-content-system-migration/02-RESEARCH.md
@.planning/phases/02-content-system-migration/02-01-SUMMARY.md
@wp-content/themes/smartvarme-theme/theme.json
@wp-content/themes/smartvarme-theme/functions.php
@wp-content/themes/smartvarme-theme/templates/single.html
@wp-content/themes/smartvarme-theme/templates/archive.html
@wp-content/themes/smartvarme-theme/src/style.scss
@wp-content/plugins/smartvarme-core/smartvarme-core.php
@wp-content/plugins/smartvarme-core/includes/class-smartvarme-core.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate FAQ page content from Kadence accordion to native Details blocks and create FAQ schema</name>
  <files>
    wp-content/plugins/smartvarme-core/includes/class-smartvarme-faq-schema.php
    wp-content/plugins/smartvarme-core/smartvarme-core.php
    wp-content/plugins/smartvarme-core/includes/class-smartvarme-core.php
    wp-content/themes/smartvarme-theme/templates/page-faq.html
  </files>
  <action>
    **Step 1: Create FAQ page template (page-faq.html)**

    Create `wp-content/themes/smartvarme-theme/templates/page-faq.html` -- a custom page template for the FAQ page. WordPress template hierarchy will auto-select this for the page with slug "faq".

    Template content:
    - Header template part
    - Main group (constrained layout) containing:
      - `<!-- wp:post-title {"level":1} /-->` for the page title
      - `<!-- wp:post-content {"layout":{"type":"constrained"}} /-->` for the page content
    - Footer template part

    This is a clean template that lets the page content (with accordion blocks) render properly.

    **Step 2: Migrate FAQ page content via WP-CLI**

    Use WP-CLI to update post ID 24464 (the FAQ page) with new content that replaces the Kadence accordion blocks with native WordPress Details blocks.

    The existing FAQ page has 6 questions (from the Kadence accordion). Replace the entire post_content with native blocks:

    ```
    <!-- wp:heading {"level":1} -->
    <h1>FAQ - Ofte stilte sporsmal</h1>
    <!-- /wp:heading -->

    <!-- wp:paragraph -->
    <p>Her er de vanligste sporsmalen og svarene om nettsiden og produktene.</p>
    <!-- /wp:paragraph -->

    <!-- wp:details -->
    <details class="wp-block-details"><summary>Hvordan foregar levering ved kjop pa nett?</summary>
    <!-- wp:paragraph -->
    <p>Leveringen foregar med Bring, som leverer helt til doren din eller til et annet sted som du oppgir.</p>
    <!-- /wp:paragraph -->
    </details>
    <!-- /wp:details -->

    [... repeat for all 6 FAQ items with original Norwegian text ...]
    ```

    The 6 FAQ items to migrate (preserve exact Norwegian text from original):
    1. "Hvordan foregar levering ved kjop pa nett?" -> Answer about Bring delivery
    2. "Hvor raskt leveres varen ved kjop pa nett?" -> Answer about delivery time per supplier
    3. "Hvor kan jeg fa hjelp til montering?" -> Answer about Bergen area installation
    4. "Hva er regler for montering av ildsted?" -> Answer about self-installation rules
    5. "Jeg er bedrift - kan jeg fa andre betingelser?" -> Answer about contacting for business terms
    6. (There are only 5 visible in the extracted content, but check for a 6th -- the Kadence accordion says paneCount:6)

    IMPORTANT: Use the EXACT original Norwegian text with proper UTF-8 characters (o with slash, a with ring, etc.) from the database. Run `npx @wordpress/env run cli wp post get 24464 --field=post_content` to get the exact text before migrating.

    To update the post content, create a temporary file with the new block markup and use:
    ```bash
    npx @wordpress/env run cli wp post update 24464 /path/to/new-faq-content.html
    ```
    Or use wp-cli's `--post_content` flag if content is short enough, or pipe via stdin.

    **Step 3: Create FAQ Schema class in plugin**

    Create `wp-content/plugins/smartvarme-core/includes/class-smartvarme-faq-schema.php`:

    This class:
    - Hooks into `wp_head` action
    - On pages with slug 'faq' (or any page containing `wp-block-details` blocks), parses the post content
    - Extracts `<summary>` text (question) and the content within `<details>` after summary (answer)
    - Generates FAQPage JSON-LD schema markup
    - Outputs a `<script type="application/ld+json">` tag in the head

    Schema structure:
    ```json
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "Question text",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Answer text"
          }
        }
      ]
    }
    ```

    Use `parse_blocks()` WordPress function to parse post content and find `core/details` blocks. Extract question from the block's inner HTML `<summary>` tag and answer from the paragraph blocks within.

    Sanitize output with `wp_json_encode()` with `JSON_UNESCAPED_UNICODE` and `JSON_UNESCAPED_SLASHES` flags.

    **Step 4: Wire FAQ schema into plugin**

    In `class-smartvarme-core.php`, add a method to load the FAQ schema class. In the `run()` method, require and instantiate `Smartvarme_FAQ_Schema`.

    In `smartvarme-core.php`, no changes needed (it already calls `run()`).

    Alternatively, add a `require_once` for the FAQ schema file in the main plugin file's `run_smartvarme_core()` function area and instantiate there, OR load it in class-smartvarme-core.php's constructor/run method. Choose the approach that fits the existing boilerplate pattern (the current pattern uses class-smartvarme-core.php as the orchestrator).
  </action>
  <verify>
    1. `php -l wp-content/plugins/smartvarme-core/includes/class-smartvarme-faq-schema.php` passes
    2. `ls wp-content/themes/smartvarme-theme/templates/page-faq.html` exists
    3. Run inside Docker: `npx @wordpress/env run cli wp post get 24464 --field=post_content` and confirm it contains `wp:details` blocks (not `kadence/accordion`)
    4. Run inside Docker: `npx @wordpress/env run cli wp eval "echo do_shortcode('[smartvarme_test_schema]');"` or visit http://localhost:8080/faq/ and view page source to find `application/ld+json` containing `FAQPage`
    5. Confirm FAQ page loads at http://localhost:8080/faq/ without PHP errors: `npx @wordpress/env run cli wp eval "echo wp_remote_retrieve_response_code(wp_remote_get('http://localhost/faq/'));"` should return 200
  </verify>
  <done>
    FAQ page (post ID 24464) content uses native WordPress Details blocks instead of Kadence accordion. FAQPage JSON-LD schema is output in page head. Page template page-faq.html exists for clean FAQ rendering.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance blog templates (single post and archive) and add content styles</name>
  <files>
    wp-content/themes/smartvarme-theme/templates/single.html
    wp-content/themes/smartvarme-theme/templates/archive.html
    wp-content/themes/smartvarme-theme/src/style.scss
  </files>
  <action>
    **Step 1: Enhance single.html (single post template)**

    Replace the minimal single.html with an enhanced version:
    - Header template part
    - Main group (constrained layout) with:
      - `<!-- wp:post-featured-image {"isLink":false,"aspectRatio":"16/9","style":{"spacing":{"margin":{"bottom":"var:preset|spacing|medium"}}}} /-->` (full-width featured image at top)
      - `<!-- wp:post-title {"level":1} /-->` (H1 title)
      - A Group block containing post metadata:
        - `<!-- wp:post-date /-->` and `<!-- wp:post-terms {"term":"category"} /-->` in a horizontal layout (flex row)
      - `<!-- wp:separator {"className":"is-style-wide"} -->` divider
      - `<!-- wp:post-content {"layout":{"type":"constrained"}} /-->` (the article content)
      - A post navigation block at the bottom: `<!-- wp:post-navigation-link {"type":"previous"} /-->` and `<!-- wp:post-navigation-link /-->`
    - Footer template part

    **Step 2: Enhance archive.html (post archive/blog listing)**

    Replace the basic archive.html with an enhanced version:
    - Header template part
    - Main group (constrained layout) with:
      - `<!-- wp:query-title {"type":"archive"} /-->` for archive page title
      - `<!-- wp:query {"queryId":1,"query":{"perPage":9,"postType":"post","order":"desc","orderBy":"date"},"displayLayout":{"type":"flex","columns":3}} -->` containing:
        - Post template with each post as a card:
          - Featured image (linked, aspect ratio 16/9)
          - Post title (linked, H3)
          - Post excerpt
          - Post date in smaller text
        - Query pagination (previous, numbers, next)
    - Footer template part

    **Step 3: Add content styles in style.scss**

    Add styles to `wp-content/themes/smartvarme-theme/src/style.scss` (append to existing content, do NOT replace):

    ```scss
    // FAQ Accordion (Details block) styles
    .wp-block-details {
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      margin-bottom: 0.5rem;
      overflow: hidden;

      summary {
        padding: 1rem 1.25rem;
        font-weight: 600;
        cursor: pointer;
        background-color: var(--wp--preset--color--surface, #f8f9fa);
        transition: background-color 0.2s ease;
        list-style: none;

        &::-webkit-details-marker {
          display: none;
        }

        &::before {
          content: '+';
          display: inline-block;
          width: 1.5rem;
          font-weight: bold;
          color: var(--wp--preset--color--gold, #f7a720);
        }

        &:hover {
          background-color: #eeeeee;
        }
      }

      &[open] summary::before {
        content: 'âˆ’';
      }

      // Inner content padding
      > :not(summary) {
        padding: 0 1.25rem 1rem;
      }
    }

    // Blog card styles for archive
    .wp-block-post-template {
      .wp-block-post {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        transition: box-shadow 0.2s ease;

        &:hover {
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
      }

      .wp-block-post-featured-image {
        margin-bottom: 0;
      }

      .wp-block-post-title {
        padding: 0 1rem;
        margin-top: 1rem;
      }

      .wp-block-post-excerpt {
        padding: 0 1rem;
      }

      .wp-block-post-date {
        padding: 0 1rem 1rem;
        font-size: var(--wp--preset--font-size--small);
        color: var(--wp--preset--color--secondary);
      }
    }

    // Single post featured image
    .wp-block-post-featured-image {
      border-radius: 8px;
      overflow: hidden;
    }

    // Post navigation
    .wp-block-post-navigation-link {
      font-weight: 600;
      color: var(--wp--preset--color--gold, #f7a720);
    }
    ```

    After updating style.scss, rebuild the theme: `cd wp-content/themes/smartvarme-theme && npm run build`
  </action>
  <verify>
    1. `cat wp-content/themes/smartvarme-theme/templates/single.html` contains `wp:post-featured-image`
    2. `cat wp-content/themes/smartvarme-theme/templates/archive.html` contains `wp:query` with `columns`
    3. `cd wp-content/themes/smartvarme-theme && npm run build` completes without errors
    4. `ls wp-content/themes/smartvarme-theme/build/style-index.css` exists and contains `wp-block-details` styles
    5. Visit http://localhost:8080/faq/ -- FAQ items should render as expandable accordions
    6. Visit any blog post URL (e.g., http://localhost:8080/spar-penger-i-vinter-med-det-rette-ildstedet/) -- should show enhanced layout
  </verify>
  <done>
    Single post template shows featured image, metadata, content, and navigation. Archive template displays posts in 3-column card grid. FAQ accordions have clean styling with expand/collapse indicators. Theme build succeeds with new styles.
  </done>
</task>

</tasks>

<verification>
1. FAQ page at /faq/ displays native WordPress Details blocks (not Kadence accordion)
2. View page source of /faq/ contains `<script type="application/ld+json">` with FAQPage schema
3. Blog posts display with featured image, title, date, category, and navigation
4. Archive page shows posts in card grid layout
5. Accordion items expand/collapse with styled summary markers
6. `npm run build` in theme directory completes without errors
7. No Kadence block references remain in FAQ page content
</verification>

<success_criteria>
- FAQ page content migrated from Kadence accordion to native WordPress Details blocks
- FAQPage JSON-LD schema outputs in page head on FAQ page
- Single post template includes featured image, metadata, content, and post navigation
- Archive template displays posts in responsive card grid
- Content styles compiled into build/style-index.css
- All existing FAQ questions and answers preserved with original Norwegian text
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-system-migration/02-02-SUMMARY.md`
</output>
