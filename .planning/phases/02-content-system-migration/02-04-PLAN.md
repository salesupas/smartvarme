---
phase: 02-content-system-migration
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - wp-content/plugins/smartvarme-core/blocks/product-comparison/index.php
  - wp-content/plugins/smartvarme-core/blocks/product-comparison/src/index.js
  - wp-content/plugins/smartvarme-core/blocks/product-comparison/src/edit.js
  - wp-content/plugins/smartvarme-core/blocks/product-comparison/src/save.js
  - wp-content/plugins/smartvarme-core/blocks/product-comparison/src/style.scss
  - wp-content/plugins/smartvarme-core/blocks/energy-calculator/index.php
  - wp-content/plugins/smartvarme-core/blocks/energy-calculator/src/index.js
  - wp-content/plugins/smartvarme-core/blocks/energy-calculator/src/edit.js
  - wp-content/plugins/smartvarme-core/blocks/energy-calculator/src/save.js
  - wp-content/plugins/smartvarme-core/blocks/energy-calculator/src/style.scss
  - wp-content/plugins/smartvarme-core/smartvarme-core.php
autonomous: true

must_haves:
  truths:
    - "Product comparison block appears in block inserter"
    - "Energy calculator block appears in block inserter"
    - "Product comparison allows selecting 2-3 products for side-by-side feature comparison"
    - "Energy calculator accepts house size and insulation inputs, outputs recommended kW and product suggestions"
    - "Both blocks render correctly on frontend without JavaScript errors"
  artifacts:
    - path: "wp-content/plugins/smartvarme-core/blocks/product-comparison/build/index.js"
      provides: "Compiled product comparison block"
      min_lines: 10
    - path: "wp-content/plugins/smartvarme-core/blocks/energy-calculator/build/index.js"
      provides: "Compiled energy calculator block"
      min_lines: 10
    - path: "wp-content/plugins/smartvarme-core/blocks/product-comparison/index.php"
      provides: "Server-side product comparison renderer"
      contains: "register_block_type"
    - path: "wp-content/plugins/smartvarme-core/blocks/energy-calculator/index.php"
      provides: "Server-side energy calculator renderer"
      contains: "register_block_type"
  key_links:
    - from: "wp-content/plugins/smartvarme-core/blocks/*/build/index.js"
      to: "Block editor UI"
      via: "Block registration via registerBlockType"
      pattern: "registerBlockType"
    - from: "wp-content/plugins/smartvarme-core/blocks/*/index.php"
      to: "wp-content/plugins/smartvarme-core/smartvarme-core.php"
      via: "require_once in plugin initialization"
      pattern: "require_once.*blocks/"
    - from: "Product comparison render_callback"
      to: "WooCommerce product data"
      via: "wc_get_product() queries"
      pattern: "wc_get_product"
---

<objective>
Create two custom domain-specific Gutenberg blocks: product comparison and energy savings calculator.

Purpose: Enable content editors to add interactive product comparison tables and energy calculator widgets to pages without custom code. These domain-specific blocks go beyond generic WordPress blocks to provide Smartvarme-specific functionality for heat pump selection and ROI calculation.

Output: Two custom blocks registered, built, and functional in the block editor. Product comparison block queries WooCommerce products. Energy calculator block performs heat pump sizing calculations.
</objective>

<execution_context>
@/Users/salesup/.claude/get-shit-done/workflows/execute-plan.md
@/Users/salesup/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-content-system-migration/02-RESEARCH.md
@.planning/phases/02-content-system-migration/02-01-SUMMARY.md
@wp-content/plugins/smartvarme-core/smartvarme-core.php
@wp-content/plugins/smartvarme-core/includes/class-smartvarme-core.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create product comparison block with @wordpress/create-block</name>
  <files>
    wp-content/plugins/smartvarme-core/blocks/product-comparison/index.php
    wp-content/plugins/smartvarme-core/blocks/product-comparison/src/index.js
    wp-content/plugins/smartvarme-core/blocks/product-comparison/src/edit.js
    wp-content/plugins/smartvarme-core/blocks/product-comparison/src/save.js
    wp-content/plugins/smartvarme-core/blocks/product-comparison/src/style.scss
  </files>
  <action>
    **Step 1: Scaffold the product comparison block**

    Navigate to the smartvarme-core plugin directory and create the block using @wordpress/create-block:

    ```bash
    cd wp-content/plugins/smartvarme-core
    mkdir -p blocks
    cd blocks
    npx @wordpress/create-block@latest product-comparison \
      --namespace="smartvarme" \
      --title="Produktsammenligning" \
      --description="Sammenlign varmepumper side ved side" \
      --category="widgets"
    ```

    This creates a `product-comparison/` directory with the full block structure.

    **Step 2: Configure dynamic rendering**

    Edit `blocks/product-comparison/index.php` to register the block with server-side rendering:

    ```php
    <?php
    /**
     * Product Comparison Block
     */

    function smartvarme_register_product_comparison_block() {
        register_block_type( __DIR__ . '/build', array(
            'render_callback' => 'smartvarme_render_product_comparison',
            'attributes'      => array(
                'productIds' => array(
                    'type'    => 'array',
                    'default' => array(),
                ),
            ),
        ) );
    }
    add_action( 'init', 'smartvarme_register_product_comparison_block' );

    function smartvarme_render_product_comparison( $attributes ) {
        $product_ids = isset( $attributes['productIds'] ) ? $attributes['productIds'] : array();

        if ( empty( $product_ids ) ) {
            return '<div class="wp-block-smartvarme-product-comparison"><p>Velg produkter å sammenligne i blokkinnstillingene.</p></div>';
        }

        // Query products
        $products = array();
        foreach ( $product_ids as $id ) {
            $product = wc_get_product( absint( $id ) );
            if ( $product && $product->is_visible() ) {
                $products[] = $product;
            }
        }

        if ( empty( $products ) ) {
            return '<div class="wp-block-smartvarme-product-comparison"><p>Ingen produkter funnet.</p></div>';
        }

        // Render comparison table
        ob_start();
        ?>
        <div class="wp-block-smartvarme-product-comparison">
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Funksjon</th>
                        <?php foreach ( $products as $product ) : ?>
                            <th><?php echo esc_html( $product->get_name() ); ?></th>
                        <?php endforeach; ?>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Pris</td>
                        <?php foreach ( $products as $product ) : ?>
                            <td><?php echo $product->get_price_html(); ?></td>
                        <?php endforeach; ?>
                    </tr>
                    <tr>
                        <td>Effekt (kW)</td>
                        <?php foreach ( $products as $product ) : ?>
                            <td><?php echo esc_html( $product->get_attribute( 'pa_effekt' ) ?: 'N/A' ); ?></td>
                        <?php endforeach; ?>
                    </tr>
                    <tr>
                        <td>Energiklasse</td>
                        <?php foreach ( $products as $product ) : ?>
                            <td><?php echo esc_html( $product->get_attribute( 'pa_energiklasse' ) ?: 'N/A' ); ?></td>
                        <?php endforeach; ?>
                    </tr>
                    <tr>
                        <td>Leveringstid</td>
                        <?php foreach ( $products as $product ) : ?>
                            <td><?php echo esc_html( $product->get_meta( '_delivery_time' ) ?: '2-4 uker' ); ?></td>
                        <?php endforeach; ?>
                    </tr>
                </tbody>
            </table>
        </div>
        <?php
        return ob_get_clean();
    }
    ```

    **Step 3: Implement block editor UI**

    Edit `blocks/product-comparison/src/edit.js` to add product selection in the block editor:

    ```javascript
    import { __ } from '@wordpress/i18n';
    import { useBlockProps, InspectorControls } from '@wordpress/block-editor';
    import { PanelBody, SelectControl, Button } from '@wordpress/components';
    import { useState, useEffect } from '@wordpress/element';
    import apiFetch from '@wordpress/api-fetch';
    import './editor.scss';

    export default function Edit({ attributes, setAttributes }) {
        const { productIds } = attributes;
        const [products, setProducts] = useState([]);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            // Fetch WooCommerce products
            apiFetch({ path: '/wc/v3/products?per_page=50' })
                .then((data) => {
                    setProducts(data);
                    setLoading(false);
                })
                .catch(() => setLoading(false));
        }, []);

        const addProduct = () => {
            setAttributes({ productIds: [...productIds, 0] });
        };

        const removeProduct = (index) => {
            const newIds = [...productIds];
            newIds.splice(index, 1);
            setAttributes({ productIds: newIds });
        };

        const updateProduct = (index, productId) => {
            const newIds = [...productIds];
            newIds[index] = parseInt(productId);
            setAttributes({ productIds: newIds });
        };

        return (
            <>
                <InspectorControls>
                    <PanelBody title={__('Produkter å sammenligne', 'smartvarme')}>
                        {productIds.map((id, index) => (
                            <div key={index} style={{ marginBottom: '16px' }}>
                                <SelectControl
                                    label={__('Produkt ' + (index + 1), 'smartvarme')}
                                    value={id}
                                    options={[
                                        { label: __('Velg produkt...', 'smartvarme'), value: 0 },
                                        ...products.map((p) => ({
                                            label: p.name,
                                            value: p.id,
                                        })),
                                    ]}
                                    onChange={(value) => updateProduct(index, value)}
                                />
                                <Button isDestructive onClick={() => removeProduct(index)}>
                                    {__('Fjern', 'smartvarme')}
                                </Button>
                            </div>
                        ))}
                        <Button isPrimary onClick={addProduct}>
                            {__('Legg til produkt', 'smartvarme')}
                        </Button>
                    </PanelBody>
                </InspectorControls>

                <div {...useBlockProps()}>
                    {loading ? (
                        <p>{__('Laster produkter...', 'smartvarme')}</p>
                    ) : productIds.length === 0 ? (
                        <p>{__('Velg produkter i sidepanelet →', 'smartvarme')}</p>
                    ) : (
                        <p>
                            {__('Sammenligner ' + productIds.filter((id) => id > 0).length + ' produkter', 'smartvarme')}
                        </p>
                    )}
                </div>
            </>
        );
    }
    ```

    **Step 4: Add styles**

    Edit `blocks/product-comparison/src/style.scss`:

    ```scss
    .wp-block-smartvarme-product-comparison {
        margin: 2rem 0;

        .comparison-table {
            width: 100%;
            border-collapse: collapse;

            th,
            td {
                padding: 1rem;
                border: 1px solid #e0e0e0;
                text-align: left;
            }

            thead th {
                background-color: var(--wp--preset--color--primary, #003d5b);
                color: white;
                font-weight: 600;
            }

            tbody tr:nth-child(even) {
                background-color: #f8f9fa;
            }

            tbody td:first-child {
                font-weight: 600;
            }
        }
    }
    ```

    **Step 5: Build the block**

    ```bash
    cd wp-content/plugins/smartvarme-core/blocks/product-comparison
    npm install
    npm run build
    ```

    IMPORTANT: Per research (Pattern 3: Dynamic Block), use server-side rendering for blocks that query databases. The edit.js is for the editor UI only; render_callback handles frontend output. This avoids frontend JavaScript complexity and improves performance.
  </action>
  <verify>
    1. `ls wp-content/plugins/smartvarme-core/blocks/product-comparison/build/index.js` exists (block compiled)
    2. `php -l wp-content/plugins/smartvarme-core/blocks/product-comparison/index.php` passes syntax check
    3. `grep -q "register_block_type" wp-content/plugins/smartvarme-core/blocks/product-comparison/index.php` (block registration present)
    4. `grep -q "wc_get_product" wp-content/plugins/smartvarme-core/blocks/product-comparison/index.php` (WooCommerce product query present)
    5. `cd wp-content/plugins/smartvarme-core/blocks/product-comparison && npm run build` completes without errors
  </verify>
  <done>
    Product comparison block created with @wordpress/create-block, configured for server-side rendering, editor UI allows selecting products from WooCommerce, build succeeds, comparison table renders product price/power/energy class/delivery time.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create energy calculator block with server-side calculation</name>
  <files>
    wp-content/plugins/smartvarme-core/blocks/energy-calculator/index.php
    wp-content/plugins/smartvarme-core/blocks/energy-calculator/src/index.js
    wp-content/plugins/smartvarme-core/blocks/energy-calculator/src/edit.js
    wp-content/plugins/smartvarme-core/blocks/energy-calculator/src/save.js
    wp-content/plugins/smartvarme-core/blocks/energy-calculator/src/style.scss
  </files>
  <action>
    **Step 1: Scaffold the energy calculator block**

    ```bash
    cd wp-content/plugins/smartvarme-core/blocks
    npx @wordpress/create-block@latest energy-calculator \
      --namespace="smartvarme" \
      --title="Energikalkulator" \
      --description="Beregn anbefalt varmepumpeeffekt og energisparing" \
      --category="widgets"
    ```

    **Step 2: Configure dynamic rendering with calculation logic**

    Edit `blocks/energy-calculator/index.php`:

    ```php
    <?php
    /**
     * Energy Calculator Block
     */

    function smartvarme_register_energy_calculator_block() {
        register_block_type( __DIR__ . '/build', array(
            'render_callback' => 'smartvarme_render_energy_calculator',
            'attributes'      => array(
                'defaultSquareMeters' => array(
                    'type'    => 'number',
                    'default' => 100,
                ),
                'defaultInsulation' => array(
                    'type'    => 'string',
                    'default' => 'medium',
                ),
            ),
        ) );
    }
    add_action( 'init', 'smartvarme_register_energy_calculator_block' );

    function smartvarme_render_energy_calculator( $attributes ) {
        $default_sqm = isset( $attributes['defaultSquareMeters'] ) ? absint( $attributes['defaultSquareMeters'] ) : 100;
        $default_insulation = isset( $attributes['defaultInsulation'] ) ? sanitize_text_field( $attributes['defaultInsulation'] ) : 'medium';

        // Energy calculation logic (simplified heat loss formula)
        function calculate_heat_need( $sqm, $insulation ) {
            $base_watt_per_sqm = array(
                'poor'   => 100,  // 100W/m² for poor insulation
                'medium' => 70,   // 70W/m² for medium insulation
                'good'   => 50,   // 50W/m² for good insulation
            );

            $watt_per_sqm = isset( $base_watt_per_sqm[ $insulation ] ) ? $base_watt_per_sqm[ $insulation ] : 70;
            $total_watts = $sqm * $watt_per_sqm;
            $total_kw = ceil( $total_watts / 1000 );

            return $total_kw;
        }

        $calculated_kw = calculate_heat_need( $default_sqm, $default_insulation );

        // Query recommended products based on kW
        $recommended_products = wc_get_products( array(
            'limit' => 3,
            'orderby' => 'meta_value_num',
            'order' => 'ASC',
            'meta_key' => '_effekt_kw',
            'meta_query' => array(
                array(
                    'key' => '_effekt_kw',
                    'value' => $calculated_kw,
                    'compare' => '>=',
                    'type' => 'NUMERIC',
                ),
            ),
        ) );

        ob_start();
        ?>
        <div class="wp-block-smartvarme-energy-calculator">
            <div class="calculator-form">
                <h3>Beregn din varmepumpestørrelse</h3>
                <form method="get" action="">
                    <div class="form-group">
                        <label for="sqm">Boligareal (m²):</label>
                        <input type="number" id="sqm" name="sqm" value="<?php echo esc_attr( $default_sqm ); ?>" min="20" max="500" step="10">
                    </div>

                    <div class="form-group">
                        <label for="insulation">Isolasjonskvalitet:</label>
                        <select id="insulation" name="insulation">
                            <option value="poor" <?php selected( $default_insulation, 'poor' ); ?>>Dårlig (før 1970)</option>
                            <option value="medium" <?php selected( $default_insulation, 'medium' ); ?>>Middels (1970-2000)</option>
                            <option value="good" <?php selected( $default_insulation, 'good' ); ?>>God (etter 2000)</option>
                        </select>
                    </div>

                    <button type="submit" class="wp-block-button__link">Beregn</button>
                </form>
            </div>

            <div class="calculator-result">
                <h4>Anbefaling for <?php echo esc_html( $default_sqm ); ?> m²:</h4>
                <p class="result-highlight">Du trenger en varmepumpe på minst <strong><?php echo esc_html( $calculated_kw ); ?> kW</strong></p>

                <?php if ( ! empty( $recommended_products ) ) : ?>
                    <h5>Anbefalte produkter:</h5>
                    <div class="recommended-products">
                        <?php foreach ( $recommended_products as $product ) : ?>
                            <div class="product-card">
                                <?php echo $product->get_image( 'thumbnail' ); ?>
                                <h6><?php echo esc_html( $product->get_name() ); ?></h6>
                                <p class="price"><?php echo $product->get_price_html(); ?></p>
                                <p class="power"><?php echo esc_html( $product->get_attribute( 'pa_effekt' ) ?: $calculated_kw . ' kW' ); ?></p>
                                <a href="<?php echo esc_url( $product->get_permalink() ); ?>" class="wp-block-button__link is-style-outline">
                                    Se produkt
                                </a>
                            </div>
                        <?php endforeach; ?>
                    </div>
                <?php endif; ?>

                <p class="disclaimer"><small>Dette er en estimering. Kontakt oss for en nøyaktig vurdering basert på ditt hjem.</small></p>
            </div>
        </div>
        <?php
        return ob_get_clean();
    }
    ```

    **Step 3: Implement editor UI**

    Edit `blocks/energy-calculator/src/edit.js`:

    ```javascript
    import { __ } from '@wordpress/i18n';
    import { useBlockProps, InspectorControls } from '@wordpress/block-editor';
    import { PanelBody, RangeControl, SelectControl } from '@wordpress/components';
    import './editor.scss';

    export default function Edit({ attributes, setAttributes }) {
        const { defaultSquareMeters, defaultInsulation } = attributes;

        return (
            <>
                <InspectorControls>
                    <PanelBody title={__('Standardinnstillinger', 'smartvarme')}>
                        <RangeControl
                            label={__('Standard boligareal (m²)', 'smartvarme')}
                            value={defaultSquareMeters}
                            onChange={(value) => setAttributes({ defaultSquareMeters: value })}
                            min={20}
                            max={500}
                            step={10}
                        />
                        <SelectControl
                            label={__('Standard isolasjon', 'smartvarme')}
                            value={defaultInsulation}
                            options={[
                                { label: __('Dårlig', 'smartvarme'), value: 'poor' },
                                { label: __('Middels', 'smartvarme'), value: 'medium' },
                                { label: __('God', 'smartvarme'), value: 'good' },
                            ]}
                            onChange={(value) => setAttributes({ defaultInsulation: value })}
                        />
                    </PanelBody>
                </InspectorControls>

                <div {...useBlockProps()}>
                    <div className="calculator-preview">
                        <h3>{__('Energikalkulator', 'smartvarme')}</h3>
                        <p>
                            {__('Standard: ', 'smartvarme')}
                            {defaultSquareMeters} m², {defaultInsulation} {__('isolasjon', 'smartvarme')}
                        </p>
                        <p className="notice">
                            {__('Kalkulatoren vil vises på frontend. Rediger standardverdier i sidepanelet →', 'smartvarme')}
                        </p>
                    </div>
                </div>
            </>
        );
    }
    ```

    **Step 4: Add styles**

    Edit `blocks/energy-calculator/src/style.scss`:

    ```scss
    .wp-block-smartvarme-energy-calculator {
        padding: 2rem;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin: 2rem 0;

        .calculator-form {
            margin-bottom: 2rem;

            .form-group {
                margin-bottom: 1rem;

                label {
                    display: block;
                    font-weight: 600;
                    margin-bottom: 0.5rem;
                }

                input,
                select {
                    width: 100%;
                    max-width: 300px;
                    padding: 0.5rem;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                }
            }
        }

        .calculator-result {
            .result-highlight {
                font-size: 1.25rem;
                color: var(--wp--preset--color--primary, #003d5b);
                margin: 1rem 0;
            }

            .recommended-products {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
                margin: 1rem 0;

                .product-card {
                    border: 1px solid #e0e0e0;
                    padding: 1rem;
                    border-radius: 8px;
                    text-align: center;

                    img {
                        max-width: 100%;
                        height: auto;
                    }

                    h6 {
                        font-size: 1rem;
                        margin: 0.5rem 0;
                    }

                    .price {
                        font-weight: 600;
                        color: var(--wp--preset--color--gold, #f7a720);
                    }

                    .power {
                        font-size: 0.875rem;
                        color: #666;
                    }
                }
            }

            .disclaimer {
                margin-top: 1.5rem;
                color: #666;
                font-style: italic;
            }
        }
    }
    ```

    **Step 5: Build the block**

    ```bash
    cd wp-content/plugins/smartvarme-core/blocks/energy-calculator
    npm install
    npm run build
    ```

    IMPORTANT: Calculator uses server-side rendering to avoid exposing calculation logic in frontend JavaScript. Form submission reloads the page with query parameters, which the render_callback reads to recalculate. This approach is simpler and more performant than client-side state management for this use case.
  </action>
  <verify>
    1. `ls wp-content/plugins/smartvarme-core/blocks/energy-calculator/build/index.js` exists
    2. `php -l wp-content/plugins/smartvarme-core/blocks/energy-calculator/index.php` passes syntax check
    3. `grep -q "calculate_heat_need" wp-content/plugins/smartvarme-core/blocks/energy-calculator/index.php` (calculation logic present)
    4. `grep -q "wc_get_products" wp-content/plugins/smartvarme-core/blocks/energy-calculator/index.php` (product recommendation query present)
    5. `cd wp-content/plugins/smartvarme-core/blocks/energy-calculator && npm run build` completes without errors
  </verify>
  <done>
    Energy calculator block created with heat loss calculation logic (100W/m² poor, 70W/m² medium, 50W/m² good insulation), form accepts house size and insulation inputs, outputs recommended kW and 3 matching products from WooCommerce, build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire custom blocks into plugin and verify registration</name>
  <files>
    wp-content/plugins/smartvarme-core/smartvarme-core.php
  </files>
  <action>
    **Step 1: Load custom blocks in plugin**

    Edit `wp-content/plugins/smartvarme-core/smartvarme-core.php` to require the block registration files. Add this code after the existing plugin setup code (around line 60-70, after the `run_smartvarme_core()` function definition):

    ```php
    /**
     * Load custom blocks
     */
    function smartvarme_load_custom_blocks() {
        $blocks_dir = plugin_dir_path( __FILE__ ) . 'blocks/';

        // Load product comparison block
        if ( file_exists( $blocks_dir . 'product-comparison/index.php' ) ) {
            require_once $blocks_dir . 'product-comparison/index.php';
        }

        // Load energy calculator block
        if ( file_exists( $blocks_dir . 'energy-calculator/index.php' ) ) {
            require_once $blocks_dir . 'energy-calculator/index.php';
        }
    }
    add_action( 'plugins_loaded', 'smartvarme_load_custom_blocks' );
    ```

    **Step 2: Verify blocks appear in editor**

    After adding the block loading code, the blocks should automatically register via the `init` hooks in each block's index.php file.

    Use WP-CLI to verify block registration:

    ```bash
    # List all registered blocks (should include smartvarme/product-comparison and smartvarme/energy-calculator)
    npx @wordpress/env run cli wp eval "
      \$blocks = WP_Block_Type_Registry::get_instance()->get_all_registered();
      foreach ( \$blocks as \$name => \$block ) {
        if ( strpos( \$name, 'smartvarme/' ) === 0 ) {
          echo \$name . PHP_EOL;
        }
      }
    "
    ```

    Expected output:
    ```
    smartvarme/product-comparison
    smartvarme/energy-calculator
    ```

    **Step 3: Test blocks in editor**

    1. Navigate to http://localhost:8080/wp-admin/post-new.php?post_type=page
    2. Click the "+" block inserter
    3. Search for "produktsammenligning" - should find the product comparison block
    4. Search for "energikalkulator" - should find the energy calculator block
    5. Insert both blocks to verify they render without JavaScript errors

    **Step 4: Create test page with both blocks**

    Use WP-CLI to create a test page with both blocks for automated verification:

    ```bash
    npx @wordpress/env run cli wp post create \
      --post_type=page \
      --post_title="Test: Custom Blocks" \
      --post_status=publish \
      --post_content='<!-- wp:smartvarme/product-comparison /-->

<!-- wp:smartvarme/energy-calculator /-->'
    ```

    This creates a page at http://localhost:8080/test-custom-blocks/ that can be visited to verify frontend rendering.

    IMPORTANT: If blocks don't appear in the inserter, check:
    1. PHP error log for syntax errors in block PHP files
    2. Browser console for JavaScript errors in block build files
    3. Block registration via WP-CLI (above command)
    4. Plugin is activated: `npx @wordpress/env run cli wp plugin list | grep smartvarme-core`
  </action>
  <verify>
    1. `grep -q "smartvarme_load_custom_blocks" wp-content/plugins/smartvarme-core/smartvarme-core.php` (block loading function exists)
    2. `npx @wordpress/env run cli wp eval "echo count(array_filter(array_keys(WP_Block_Type_Registry::get_instance()->get_all_registered()), function(\$n) { return strpos(\$n, 'smartvarme/') === 0; }));"` returns 2 (both blocks registered)
    3. `npx @wordpress/env run cli wp post list --post_type=page --s="Test: Custom Blocks" --format=count` returns 1 (test page created)
    4. Visit http://localhost:8080/test-custom-blocks/ and verify page loads without PHP errors (HTTP 200)
  </verify>
  <done>
    Custom blocks loaded in plugin initialization. Both smartvarme/product-comparison and smartvarme/energy-calculator blocks registered in WordPress. Blocks appear in block inserter. Test page created with both blocks renders successfully on frontend.
  </done>
</task>

</tasks>

<verification>
1. Both custom blocks appear in block inserter when searching for "produktsammenligning" and "energikalkulator"
2. Product comparison block allows selecting products in InspectorControls sidebar
3. Product comparison block renders comparison table on frontend with WooCommerce product data
4. Energy calculator block accepts house size and insulation inputs
5. Energy calculator block displays recommended kW and matching products
6. Both blocks build successfully with `npm run build`
7. Test page with both blocks loads without JavaScript or PHP errors
8. WP-CLI shows 2 smartvarme/* blocks registered
</verification>

<success_criteria>
- Product comparison block created using @wordpress/create-block
- Energy calculator block created using @wordpress/create-block
- Both blocks use server-side rendering (render_callback in PHP)
- Product comparison queries WooCommerce products and displays comparison table
- Energy calculator performs heat loss calculation (W/m² based on insulation)
- Energy calculator recommends products based on calculated kW requirement
- Both blocks registered in plugin and appear in block editor inserter
- Test page with both blocks renders successfully on frontend
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-system-migration/02-04-SUMMARY.md`
</output>
