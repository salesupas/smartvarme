---
phase: 05-design-user-experience
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php
  - wp-content/plugins/smartvarme-core/includes/class-smartvarme-contact-form.php
  - wp-content/themes/smartvarme-theme/parts/header.html
  - wp-content/themes/smartvarme-theme/src/style.scss
autonomous: false

user_setup:
  - service: WPForms
    why: "Contact form plugin for product inquiry forms"
    env_vars: []
    dashboard_config:
      - task: "Create product inquiry form in WP Admin > WPForms > Add New"
        location: "WordPress Admin > WPForms > Add New"

must_haves:
  truths:
    - "Product inquiry form renders on single product pages below product meta"
    - "Form submissions include product name and URL for context"
    - "FiboSearch AJAX search appears in header and returns live product results"
    - "Search bar is styled with gold accent color matching site theme"
    - "Search finds products by name, SKU, and description"
  artifacts:
    - path: "wp-content/plugins/smartvarme-core/includes/class-smartvarme-contact-form.php"
      provides: "Product inquiry form integration with WooCommerce product pages"
      contains: "woocommerce_single_product_summary"
    - path: "wp-content/themes/smartvarme-theme/parts/header.html"
      provides: "Header with FiboSearch integration"
      contains: "fibosearch"
  key_links:
    - from: "class-smartvarme-contact-form.php"
      to: "WooCommerce single product hook"
      via: "woocommerce_single_product_summary action at priority 35"
      pattern: "add_action.*woocommerce_single_product_summary"
    - from: "header.html"
      to: "FiboSearch plugin"
      via: "shortcode or search block replacement"
      pattern: "fibosearch|wp:search"
---

<objective>
Install WPForms Lite and FiboSearch plugins, integrate a product inquiry form on single product pages, add FiboSearch to the header, and visually verify the complete Phase 5 design system.

Purpose: Delivers the remaining Phase 5 functional requirements (UX-04 contact forms, UX-05 search) and verifies the complete design system (UX-01, UX-02, UX-03) works together visually across all page types.

Output: Configured plugins, product inquiry form integration, search in header, verified design system
</objective>

<execution_context>
@/Users/salesup/.claude/get-shit-done/workflows/execute-plan.md
@/Users/salesup/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-design-user-experience/05-RESEARCH.md
@.planning/phases/05-design-user-experience/05-01-SUMMARY.md
@wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php
@wp-content/themes/smartvarme-theme/parts/header.html
@wp-content/themes/smartvarme-theme/theme.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure WPForms Lite and FiboSearch plugins</name>
  <files>
wp-content/plugins/smartvarme-core/includes/class-smartvarme-contact-form.php
wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php
  </files>
  <action>
**Step 1: Install plugins via WP-CLI in Docker container:**
```bash
docker compose exec wordpress wp plugin install wpforms-lite --activate --allow-root
docker compose exec wordpress wp plugin install ajax-search-for-woocommerce --activate --allow-root
```

**Step 2: Configure FiboSearch settings via WP-CLI:**
FiboSearch stores settings in the `dgwt_wcas_settings` option. Set key values:
```bash
# Enable product image display in search results
docker compose exec wordpress wp option update dgwt_wcas_settings '{"show_product_image":"on","show_product_price":"on","show_product_desc":"on","show_product_sku":"on","min_chars":"2","search_submit_text":"Søk","mobile_overlay":"on"}' --format=json --allow-root
```
If the option format requires individual settings, use `wp option patch` instead:
```bash
docker compose exec wordpress wp option patch update dgwt_wcas_settings show_product_image on --allow-root
docker compose exec wordpress wp option patch update dgwt_wcas_settings show_product_price on --allow-root
docker compose exec wordpress wp option patch update dgwt_wcas_settings show_product_desc on --allow-root
docker compose exec wordpress wp option patch update dgwt_wcas_settings show_product_sku on --allow-root
docker compose exec wordpress wp option patch update dgwt_wcas_settings min_chars 2 --allow-root
docker compose exec wordpress wp option patch update dgwt_wcas_settings mobile_overlay on --allow-root
```

**Step 3: Create product inquiry form class:**
Create `wp-content/plugins/smartvarme-core/includes/class-smartvarme-contact-form.php`:

```php
<?php
/**
 * Contact Form Integration
 *
 * Adds product inquiry form to WooCommerce single product pages.
 * Works with WPForms Lite for form rendering.
 *
 * @package Smartvarme_Core
 */

if ( ! defined( 'WPINC' ) ) {
    die;
}

class Smartvarme_Contact_Form {

    /**
     * Constructor - register hooks
     */
    public function __construct() {
        // Add inquiry form below product meta (priority 35, after add-to-cart at 30)
        add_action( 'woocommerce_single_product_summary', array( $this, 'display_product_inquiry_form' ), 35 );

        // Add hidden product context fields to WPForms
        add_action( 'wp_footer', array( $this, 'inject_product_context_script' ) );
    }

    /**
     * Display product inquiry form on single product pages
     */
    public function display_product_inquiry_form() {
        // Only if WPForms is active
        if ( ! function_exists( 'wpforms' ) ) {
            return;
        }

        global $product;
        if ( ! $product ) {
            return;
        }

        // Find the first WPForms form (product inquiry form)
        // Users should create a form in WPForms admin; we use the first available form
        $forms = get_posts( array(
            'post_type'      => 'wpforms',
            'posts_per_page' => 1,
            'post_status'    => 'publish',
            'orderby'        => 'date',
            'order'          => 'ASC',
        ) );

        $form_id = ! empty( $forms ) ? $forms[0]->ID : 0;

        ?>
        <div class="product-inquiry-wrapper" data-product-id="<?php echo esc_attr( $product->get_id() ); ?>" data-product-name="<?php echo esc_attr( $product->get_name() ); ?>">
            <h3 class="product-inquiry-title">
                <?php esc_html_e( 'Har du spørsmål om dette produktet?', 'smartvarme-core' ); ?>
            </h3>
            <p class="product-inquiry-subtitle">
                <?php esc_html_e( 'Våre eksperter hjelper deg gjerne. Fyll ut skjemaet nedenfor.', 'smartvarme-core' ); ?>
            </p>
            <?php
            if ( $form_id > 0 ) {
                echo do_shortcode( '[wpforms id="' . $form_id . '"]' );
            } else {
                // Fallback: simple mailto link if no form exists yet
                $subject = rawurlencode( 'Spørsmål om ' . $product->get_name() );
                $body    = rawurlencode( 'Produktlenke: ' . get_permalink() );
                echo '<p><a href="mailto:post@smartvarme.no?subject=' . $subject . '&body=' . $body . '" class="wp-element-button">';
                esc_html_e( 'Send oss en e-post', 'smartvarme-core' );
                echo '</a></p>';
            }
            ?>
        </div>
        <?php
    }

    /**
     * Inject JavaScript to add product context to form submissions
     */
    public function inject_product_context_script() {
        if ( ! is_product() || ! function_exists( 'wpforms' ) ) {
            return;
        }

        global $product;
        if ( ! $product ) {
            return;
        }
        ?>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            var wrapper = document.querySelector('.product-inquiry-wrapper');
            if (!wrapper) return;

            var form = wrapper.querySelector('form');
            if (!form) return;

            // Add hidden fields for product context
            var fields = [
                { name: 'product_name', value: wrapper.dataset.productName || '' },
                { name: 'product_id', value: wrapper.dataset.productId || '' },
                { name: 'product_url', value: window.location.href }
            ];

            fields.forEach(function(field) {
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = field.name;
                input.value = field.value;
                form.appendChild(input);
            });
        });
        </script>
        <?php
    }
}
```

**Step 4: Load the contact form class from the WooCommerce integration class.**
In `class-smartvarme-woocommerce.php`, at the end of the constructor (after the existing `require_once` lines for checkout-fields.php and email-customization.php), add:
```php
// Load contact form integration
require_once SMARTVARME_CORE_PATH . 'includes/class-smartvarme-contact-form.php';
new Smartvarme_Contact_Form();
```
  </action>
  <verify>
Verify plugins installed: `docker compose exec wordpress wp plugin list --status=active --allow-root | grep -E 'wpforms|ajax-search'` shows both active.
Verify contact form class exists: `test -f wp-content/plugins/smartvarme-core/includes/class-smartvarme-contact-form.php && echo "Exists"`.
Verify WooCommerce loads contact form: `grep 'class-smartvarme-contact-form' wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php` finds the require_once.
  </verify>
  <done>
WPForms Lite and FiboSearch plugins are installed and activated. FiboSearch configured for product images, prices, SKU search, and Norwegian submit text. Product inquiry form class created and loaded via WooCommerce integration. Form renders on single product pages with product context (name, ID, URL) passed via hidden fields. Mailto fallback provided if no WPForms form has been created yet.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate FiboSearch into header and add styling</name>
  <files>
wp-content/themes/smartvarme-theme/parts/header.html
wp-content/themes/smartvarme-theme/src/style.scss
  </files>
  <action>
**Step 1: Update header.html to include search.**

Replace the current header template with an updated version that includes a search block between the logo and the navigation/cart group. FiboSearch automatically replaces the WordPress search block when active.

Updated header.html structure:
```html
<!-- wp:group {"tagName":"header","align":"full","style":{"spacing":{"padding":{"top":"1rem","bottom":"1rem"}},"color":{"background":"#ffffff"}},"layout":{"type":"default"}} -->
<header class="wp-block-group alignfull has-background" style="background-color:#ffffff">
  <!-- wp:group {"align":"wide","style":{"spacing":{"padding":{"left":"2rem","right":"2rem"}}},"layout":{"type":"flex","justifyContent":"space-between","flexWrap":"wrap"}} -->
  <div class="wp-block-group alignwide">
    <!-- wp:site-logo {"width":150} /-->

    <!-- wp:search {"label":"Søk","showLabel":false,"placeholder":"Søk etter produkter...","buttonText":"Søk","buttonUseIcon":true,"width":100,"widthUnit":"%"} /-->

    <!-- wp:group {"layout":{"type":"flex","flexWrap":"nowrap"}} -->
    <div class="wp-block-group">
      <!-- wp:navigation {"overlayMenu":"mobile"} /-->
      <!-- wp:woocommerce/mini-cart /-->
    </div>
    <!-- /wp:group -->
  </div>
  <!-- /wp:group -->
</header>
<!-- /wp:group -->
```

Key changes:
- Added `wp:search` block between logo and nav/cart group
- FiboSearch automatically replaces this search block with its AJAX-powered version when the plugin is active
- Added white background to header for clean separation
- Search has Norwegian placeholder "Søk etter produkter..." and icon button

**Step 2: Add FiboSearch and product inquiry form CSS to style.scss.**

Append the following to the END of style.scss (before the responsive breakpoints section if it exists, otherwise at the very end):

```scss
/* ============================================
   FiboSearch Styling
   Match theme gold accent color
   ============================================ */
.dgwt-wcas-search-wrapp {
  max-width: 100%;

  .dgwt-wcas-sf-wrapp input[type="search"] {
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;

    &:focus {
      border-color: var(--wp--preset--color--gold);
      outline: 2px solid var(--wp--preset--color--gold);
      outline-offset: 2px;
    }
  }

  .dgwt-wcas-search-submit {
    background-color: var(--wp--preset--color--gold);
    color: var(--wp--preset--color--primary);
    border: none;
    border-radius: 0 4px 4px 0;
    padding: 0.5rem 1rem;
    cursor: pointer;

    &:hover {
      background-color: #e89610;
    }
  }
}

// FiboSearch suggestions dropdown
.dgwt-wcas-suggestions-wrapp {
  border: 1px solid #e0e0e0;
  border-radius: 4px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);

  .dgwt-wcas-suggestion {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f0f0f0;

    &:hover,
    &.dgwt-wcas-suggestion-selected {
      background-color: var(--wp--preset--color--surface);
    }

    .dgwt-wcas-st {
      font-weight: 600;
      color: var(--wp--preset--color--primary);
    }

    .dgwt-wcas-sp {
      color: var(--wp--preset--color--gold);
      font-weight: 700;
    }
  }
}

// Header search responsive
@media (max-width: 768px) {
  .dgwt-wcas-search-wrapp {
    order: 3;
    width: 100%;
    margin-top: 0.5rem;
  }
}

/* ============================================
   Product Inquiry Form
   Styling for WPForms on product pages
   ============================================ */
.product-inquiry-wrapper {
  margin-top: var(--wp--preset--spacing--50);
  padding: var(--wp--preset--spacing--50);
  background-color: var(--wp--preset--color--surface);
  border-radius: 8px;
  border: 1px solid #e0e0e0;

  .product-inquiry-title {
    margin-top: 0;
    margin-bottom: 0.5rem;
    color: var(--wp--preset--color--primary);
    font-size: var(--wp--preset--font-size--large);
  }

  .product-inquiry-subtitle {
    color: var(--wp--preset--color--secondary);
    margin-bottom: var(--wp--preset--spacing--40);
  }

  // WPForms inside product inquiry
  .wpforms-container {
    .wpforms-field-label {
      font-weight: 600;
      color: var(--wp--preset--color--primary);
    }

    input[type="text"],
    input[type="email"],
    textarea {
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 0.75rem;

      &:focus {
        border-color: var(--wp--preset--color--gold);
        outline: 2px solid var(--wp--preset--color--gold);
        outline-offset: 2px;
      }
    }

    .wpforms-submit {
      background-color: var(--wp--preset--color--gold) !important;
      color: var(--wp--preset--color--primary) !important;
      border: none !important;
      border-radius: 4px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      cursor: pointer;

      &:hover {
        background-color: #e89610 !important;
      }
    }
  }
}
```

**Step 3: Rebuild theme assets** to compile the updated SCSS:
```bash
cd wp-content/themes/smartvarme-theme && npx @wordpress/scripts build
```
  </action>
  <verify>
Verify header has search: `grep -c 'wp:search\|fibosearch' wp-content/themes/smartvarme-theme/parts/header.html` returns at least 1.
Verify FiboSearch CSS added: `grep 'dgwt-wcas' wp-content/themes/smartvarme-theme/src/style.scss` finds FiboSearch selectors.
Verify inquiry form CSS added: `grep 'product-inquiry-wrapper' wp-content/themes/smartvarme-theme/src/style.scss` finds form styles.
Build succeeds: `cd wp-content/themes/smartvarme-theme && npx @wordpress/scripts build` exits 0.
  </verify>
  <done>
Header template includes search block (replaced by FiboSearch when plugin active). FiboSearch styled with gold accent color, accessible focus states, responsive mobile behavior. Product inquiry form styled with surface background, gold-accented inputs, and themed submit button. Theme builds successfully.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Phase 5 Design System</name>
  <files>None (verification only)</files>
  <action>
Human verification of complete Phase 5 design system. Visit the site at localhost:8080 and verify all 5 success criteria. This is a visual and functional verification checkpoint — no code changes needed.

What was built: Enhanced theme.json with fluid typography and spacing scale, restructured mobile-first CSS, product inquiry form on product pages, FiboSearch in header, responsive layout across breakpoints.

Verification steps:

1. **Modern design (UX-01):** Open homepage — site should look noticeably cleaner with consistent button styling (gold #f7a720), proper heading hierarchy, and clean spacing between sections.

2. **Typography and spacing (UX-02):** Visit a blog post, a product page, and the FAQ archive. Typography should be consistent across all three — same font family, similar heading weights, consistent spacing.

3. **Responsive design (UX-03):** Open browser dev tools (F12) and test at:
   - 320px width (mobile): content stacks vertically, search bar full width, navigation is hamburger menu
   - 768px width (tablet): two-column layouts appear, reasonable spacing
   - 1440px width (desktop): full layout with proper content width constraint

4. **Contact form (UX-04):** Visit any single product page. Scroll below add-to-cart — "Har du spørsmål om dette produktet?" section should appear. User action needed: Create inquiry form in WP Admin > WPForms > Add New (Name, Email, Message fields).

5. **Search (UX-05):** Click search in header. Type "varmepumpe" — FiboSearch should show AJAX live results with product images and prices.
  </action>
  <verify>All 5 success criteria pass visual inspection at localhost:8080.</verify>
  <done>User confirms "approved" for all 5 Phase 5 success criteria, or provides specific issues to address in a gap closure plan.</done>
</task>

</tasks>

<verification>
1. WPForms Lite plugin installed and activated
2. FiboSearch plugin installed, activated, and configured for Norwegian
3. Product inquiry form renders on single product pages (WPForms or mailto fallback)
4. FiboSearch replaces default search in header with AJAX live results
5. Search bar styled with gold accent matching theme
6. All CSS compiles without errors
7. Design system from Plan 05-01 visually verified across page types
</verification>

<success_criteria>
- Both plugins (WPForms Lite, FiboSearch) are active and configured
- Product inquiry form section appears on single product pages at priority 35
- Header contains search functionality (FiboSearch AJAX)
- FiboSearch results show product images, prices, and descriptions
- Human verification confirms all 5 Phase 5 success criteria pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-design-user-experience/05-02-SUMMARY.md`
</output>
