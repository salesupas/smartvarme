---
phase: 06-performance-plugin-optimization
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - wp-content/plugins/smartvarme-core/includes/class-smartvarme-performance.php
autonomous: false
user_setup:
  - service: wp-rocket
    why: "Comprehensive page caching, CSS/JS minification, unused CSS removal, cache preloading, browser caching, and Gzip compression — handles 80% of Core Web Vitals optimizations on activation"
    env_vars: []
    dashboard_config:
      - task: "Purchase WP Rocket license ($59/year single site)"
        location: "https://wp-rocket.me/pricing/"
      - task: "Download wp-rocket.zip from your account"
        location: "https://wp-rocket.me/account/"
      - task: "Upload and activate via WordPress admin Plugins > Add New > Upload Plugin"
        location: "WordPress admin at localhost:8080/wp-admin/plugin-install.php"

must_haves:
  truths:
    - "Homepage loads with page caching enabled (HTML served from cache on repeat visits)"
    - "Cart, checkout, and account pages are excluded from caching (dynamic content works)"
    - "Image optimization is configured: WordPress native WebP output active for new uploads, existing thumbnails regenerated in WebP (optional AVIF via ShortPixel if user installs)"
    - "Core Web Vitals pass: LCP < 2.5s, INP < 200ms, CLS < 0.1 on homepage"
    - "Page load time is measurably faster than before optimization (target 50%+ reduction)"
    - "Cache hit ratio is above 80% after cache warming"
  artifacts:
    - path: "wp-content/plugins/smartvarme-core/includes/class-smartvarme-performance.php"
      provides: "WP Rocket integration filters and image optimization helpers"
      contains: "rocket_cache_reject_uri"
  key_links:
    - from: "wp-content/plugins/smartvarme-core/includes/class-smartvarme-performance.php"
      to: "WP Rocket plugin"
      via: "configure_wp_rocket() called from __construct(), registers rocket_* filter hooks (guarded by defined('WP_ROCKET_VERSION') check)"
      pattern: "configure_wp_rocket|rocket_"
---

<objective>
Configure WP Rocket for comprehensive page caching with WooCommerce cache exclusions, enable image optimization with WebP/AVIF conversion, and verify that Core Web Vitals targets are achieved (LCP < 2.5s, INP < 200ms, CLS < 0.1) with page load times reduced by 50%+ compared to pre-optimization baseline.

Purpose: This is the capstone plan that brings together all Phase 6 optimizations into measurable performance gains. WP Rocket provides the final layer of optimization (page caching, CSS/JS minification, unused CSS removal) that achieves the Core Web Vitals targets.

Output: Fully configured caching, verified Core Web Vitals scores, documented performance improvement.
</objective>

<execution_context>
@/Users/salesup/.claude/get-shit-done/workflows/execute-plan.md
@/Users/salesup/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-performance-plugin-optimization/06-RESEARCH.md
@.planning/phases/06-performance-plugin-optimization/06-01-SUMMARY.md
@wp-content/plugins/smartvarme-core/includes/class-smartvarme-performance.php
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Install WP Rocket caching plugin</name>
  <files>None (human action required — premium plugin installation)</files>
  <action>
  WP Rocket is a premium plugin that cannot be installed via WP-CLI from the repository. The user must purchase, download, and install it manually.

  **Alternative if user prefers free option:** Install WP Super Cache or LiteSpeed Cache instead:
  ```bash
  npx wp-env run cli wp plugin install wp-super-cache --activate
  ```
  However, WP Rocket is strongly recommended for its comprehensive Core Web Vitals optimization features (unused CSS removal, critical CSS, delay JavaScript, cache preloading).

  **Instructions for user:**
  1. Purchase WP Rocket license at https://wp-rocket.me/pricing/ ($59/year for 1 site)
  2. Download wp-rocket.zip from https://wp-rocket.me/account/
  3. Go to WordPress admin: http://localhost:8080/wp-admin/plugin-install.php
  4. Click "Upload Plugin" > Choose File > select wp-rocket.zip > Install Now
  5. Click "Activate Plugin"
  6. Verify WP Rocket dashboard appears at Settings > WP Rocket

  **If you prefer a free alternative**, type "use free caching" and we will configure WP Super Cache instead.
  **If WP Rocket is already installed**, type "already installed" to proceed.

  Resume signal: Type "installed", "already installed", or "use free caching" to proceed.
  </action>
  <verify>Run `npx wp-env run cli wp plugin list --status=active | grep -E "rocket|super-cache"` to confirm caching plugin is active.</verify>
  <done>WP Rocket (or free alternative) is installed and activated in WordPress admin.</done>
</task>

<task type="auto">
  <name>Task 2: Configure caching, image optimization, and verify performance</name>
  <files>wp-content/plugins/smartvarme-core/includes/class-smartvarme-performance.php</files>
  <action>
  Configure the installed caching plugin and add integration code to the performance module.

  **Step 1: Deactivate WP Fastest Cache (replaced by new caching)**
  ```bash
  npx wp-env run cli wp plugin deactivate wp-fastest-cache
  ```

  **Step 2: Configure WP Rocket via WP-CLI and filters**

  If WP Rocket is installed, configure these settings via WP-CLI:
  ```bash
  # Enable page caching (on by default)
  npx wp-env run cli wp option update wp_rocket_settings --format=json '...'
  ```

  Key WP Rocket settings to enable:
  - Page caching: enabled (default)
  - Browser caching: enabled
  - Gzip compression: enabled
  - CSS minification: enabled
  - JS minification: enabled
  - Remove unused CSS: enabled
  - Delay JavaScript: enabled (with exclusions for critical scripts)
  - Lazy load images: enabled (WP Rocket respects `loading="eager"` attributes)
  - Cache preloading: enabled (crawls sitemap)
  - Database optimization: enable transient cleanup (complements our custom cleanup)

  **Step 3: Add WP Rocket integration filters to class-smartvarme-performance.php**

  Add `configure_wp_rocket()` method call to the class constructor. In the `__construct()` method of `Smartvarme_Performance`, add:
  ```php
  // In __construct(), after existing hook registrations:
  $this->configure_wp_rocket();
  ```

  Then define the `configure_wp_rocket()` method with all the filter hooks below. The method MUST check if WP Rocket is active before registering filters:
  ```php
  private function configure_wp_rocket() {
      // Only register WP Rocket filters if the plugin is active
      if ( ! defined( 'WP_ROCKET_VERSION' ) ) {
          return;
      }
      // ... all rocket_* filter hooks below ...
  }
  ```

  The method registers these filters:

  a) **Cache exclusions for WooCommerce dynamic pages:**
  ```php
  add_filter('rocket_cache_reject_uri', function($uris) {
      $uris[] = '/handlekurv/(.*)';   // Norwegian cart
      $uris[] = '/kasse/(.*)';        // Norwegian checkout
      $uris[] = '/min-konto/(.*)';    // Norwegian my-account
      $uris[] = '/cart/(.*)';         // English fallback
      $uris[] = '/checkout/(.*)';
      $uris[] = '/my-account/(.*)';
      $uris[] = '/order-received/(.*)';
      return $uris;
  });
  ```

  b) **Exclude critical scripts from JS delay:**
  ```php
  add_filter('rocket_delay_js_exclusions', function($exclusions) {
      $exclusions[] = 'jquery-core';
      $exclusions[] = 'wc-add-to-cart';
      $exclusions[] = 'smartvarme-smart-search';
      $exclusions[] = 'formidable';
      return $exclusions;
  });
  ```

  c) **Delay non-essential scripts:**
  ```php
  add_filter('rocket_delay_js_scripts', function($scripts) {
      $scripts[] = 'gtag';
      $scripts[] = 'gtm';
      $scripts[] = 'fbevents';
      $scripts[] = 'google-analytics';
      $scripts[] = 'analytics';
      return $scripts;
  });
  ```

  d) **Preload critical fonts (system fonts, so minimal):**
  No web fonts to preload (system font stack from Phase 5). Skip this.

  e) **Exclude LCP images from WP Rocket lazy loading:**
  ```php
  add_filter('rocket_lazyload_excluded_attributes', function($attributes) {
      $attributes[] = 'data-no-lazy="true"';
      $attributes[] = 'fetchpriority="high"';
      return $attributes;
  });
  ```

  **Step 4: If user chose free caching (WP Super Cache):**
  Configure via wp-config.php and WP-CLI instead. Set `WP_CACHE` constant, configure cache exclusions for WooCommerce pages via WP Super Cache settings.

  **Step 5: Image Optimization Pipeline**
  WordPress 6.x includes native WebP output support (since 5.8+, full generation since 6.1). This satisfies PERF-01 for the baseline case:

  a) **Verify WordPress native WebP is active:**
  ```bash
  npx wp-env run cli wp eval "echo wp_get_image_editor(ABSPATH . 'wp-admin/images/wordpress-logo.svg') instanceof WP_Image_Editor ? 'GD/Imagick available' : 'No image editor';"
  npx wp-env run cli wp eval "echo function_exists('imagecreatefromwebp') ? 'WebP supported' : 'WebP NOT supported';"
  ```

  b) **Enable WordPress WebP output format** (if not already default):
  Add to `class-smartvarme-performance.php` constructor:
  ```php
  // Enable WebP output for uploaded images (WordPress native)
  add_filter('image_editor_output_format', function($formats) {
      $formats['image/jpeg'] = 'image/webp';
      $formats['image/png'] = 'image/webp';
      return $formats;
  });
  ```

  c) **Regenerate existing thumbnails in WebP:**
  ```bash
  npx wp-env run cli wp media regenerate --yes
  ```

  d) **Optional: ShortPixel/Imagify for AVIF** (checkpoint — ask user):
  If user wants AVIF support (better compression than WebP), recommend:
  ```bash
  npx wp-env run cli wp plugin install shortpixel-image-optimiser --activate
  ```
  Then configure: `npx wp-env run cli wp option update shortpixel_settings ...` with WebP+AVIF conversion enabled.
  If user declines, WordPress native WebP is sufficient and PERF-01 is satisfied.

  e) **Verify WebP output works:**
  ```bash
  # Check if any WebP files exist in uploads
  find wp-content/uploads -name "*.webp" | head -5
  ```

  **Step 6: Cache Warming**
  After all configuration:
  ```bash
  # Trigger cache preload via WP Rocket
  npx wp-env run cli wp eval "if(function_exists('run_rocket_bot')) { run_rocket_bot('cache-preload'); echo 'Cache warming started'; } else { echo 'WP Rocket not active'; }"
  ```

  If using WP Super Cache:
  ```bash
  npx wp-env run cli wp cache flush
  # Visit key pages to warm cache
  curl -s -o /dev/null http://localhost:8080/
  curl -s -o /dev/null http://localhost:8080/butikk/
  curl -s -o /dev/null http://localhost:8080/faq/
  ```

  **Step 7: Performance Baseline (if running locally)**
  Note: PageSpeed Insights and GTmetrix require a publicly accessible URL.
  For local verification:
  - Check page generation time via `Server-Timing` header or Query Monitor
  - Check total page weight in browser DevTools Network tab
  - Verify cache hit via `X-WP-Rocket-Cache` response header (should show `HIT` on second load)
  - Document baseline for comparison after production deployment
  </action>
  <verify>
  1. WP Fastest Cache is deactivated: `npx wp-env run cli wp plugin list --status=active | grep fastest` (should return empty)
  2. Caching plugin is active: `npx wp-env run cli wp plugin list --status=active | grep -E "rocket|super-cache"` (one must match)
  3. Cache files exist: `ls wp-content/cache/ 2>/dev/null` (should have content)
  4. Homepage cached: visit http://localhost:8080/ twice, check for cache header or faster response
  5. Cart page NOT cached: visit /handlekurv/ or /cart/ — verify dynamic content works
  6. Final active plugin count: `npx wp-env run cli wp plugin list --status=active --format=count`

  **Conditional verification (WP Rocket path):**
  7a. WP Rocket filters registered: `npx wp-env run cli wp eval "echo has_filter('rocket_cache_reject_uri') ? 'YES' : 'NO';"` (must return YES)
  7b. configure_wp_rocket() loaded: `npx wp-env run cli wp eval "echo defined('WP_ROCKET_VERSION') ? 'Rocket active, filters registered' : 'Rocket not active';"`

  **Conditional verification (Free caching path):**
  7c. If WP Super Cache: `npx wp-env run cli wp eval "echo defined('WPCACHEHOME') ? 'WP Super Cache active' : 'Not active';"` (must return active)
  7d. Cache exclusion for cart/checkout: verify /handlekurv/ and /kasse/ return fresh content (not cached)

  **Image optimization verification (both paths):**
  8. WebP filter active: `npx wp-env run cli wp eval "echo has_filter('image_editor_output_format') ? 'WebP output filter active' : 'NOT active';"` (must return active)
  9. WebP files exist: `find wp-content/uploads -name '*.webp' -type f | head -3` (should find WebP files after regeneration)
  </verify>
  <done>Caching plugin configured with WooCommerce exclusions. WP Fastest Cache deactivated. Cache warming completed. Critical scripts excluded from delay. Cache headers confirm pages are being cached. Cart/checkout pages remain dynamic (not cached). Performance module integrates with caching plugin via filters.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify performance targets and Core Web Vitals</name>
  <files>None (verification only)</files>
  <action>
  Human verification of complete Phase 6 performance optimization. This covers plugin consolidation (35 to under 15), performance code module (asset control, lazy loading, autoload monitoring), caching configuration, and image optimization.

  Verification steps:

  **1. Plugin Count Verification:**
  - Go to WordPress admin > Plugins
  - Count active plugins — must be under 15
  - Or run: `npx wp-env run cli wp plugin list --status=active --format=count`

  **2. Feature Verification (quick smoke test):**
  - Visit homepage: loads correctly, no errors
  - Visit a product page: product image, price, stock info, contact form all display
  - Visit /butikk/ (shop page): product grid loads with filtering
  - Test search: type a product name, verify results appear
  - Add product to cart: verify cart page works
  - Visit /faq/: FAQ articles display correctly
  - Visit a blog post: content renders properly

  **3. Performance Verification (browser DevTools):**
  - Open Chrome DevTools > Network tab
  - Load homepage: note total requests and page weight
  - Load a blog post: verify WooCommerce CSS/JS NOT loaded (check for woocommerce-general.css absence)
  - Load a product page: verify WooCommerce CSS/JS IS loaded

  **4. Core Web Vitals (requires public URL for full test):**
  If site is deployed:
  - Run PageSpeed Insights: https://pagespeed.web.dev/ (enter site URL)
  - Target: LCP < 2.5s, INP < 200ms, CLS < 0.1
  - Screenshot results

  If testing locally:
  - Open Chrome DevTools > Lighthouse tab
  - Run "Performance" audit on homepage
  - Note Performance score (target: 80+)
  - Check LCP, INP, CLS metrics

  **5. Caching Verification:**
  - Load homepage twice
  - Second load should be significantly faster
  - Check response headers for cache hit indicator
  - Visit /cart/ page — should NOT show cache hit (dynamic page)

  Resume signal: Type "approved" if all checks pass, or describe any issues found.
  </action>
  <verify>User confirms all 5 verification areas pass. Plugin count under 15. All features work. Performance improved. Core Web Vitals on track. Caching active.</verify>
  <done>All Phase 6 success criteria verified by human: plugin count under 15, features intact, caching active, Core Web Vitals on track, performance measurably improved.</done>
</task>

</tasks>

<verification>
1. WP Rocket (or alternative) active and configured
2. WP Fastest Cache deactivated
3. WooCommerce pages excluded from cache
4. Cache warming completed (key pages cached)
5. Critical scripts excluded from JS delay
6. Analytics/tracking scripts delayed until interaction
7. Homepage serves cached HTML on repeat visits
8. Lighthouse Performance score 80+ locally
9. All Phase 6 success criteria addressed
</verification>

<success_criteria>
- Caching plugin configured and serving cached pages
- WooCommerce dynamic pages (cart, checkout, account) excluded from cache
- Cache hit ratio measurable (second page load faster than first)
- Core Web Vitals pass on Lighthouse (LCP < 2.5s, INP < 200ms, CLS < 0.1) or documented baseline for production verification
- Total active plugin count under 15
- All site features functional (forms, search, products, checkout, FAQ)
- Page load times measurably reduced vs uncached baseline
</success_criteria>

<output>
After completion, create `.planning/phases/06-performance-plugin-optimization/06-02-SUMMARY.md`
</output>
