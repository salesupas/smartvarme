---
phase: 06-performance-plugin-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - wp-content/plugins/smartvarme-core/includes/class-smartvarme-core.php
  - wp-content/plugins/smartvarme-core/includes/class-smartvarme-performance.php
  - wp-content/themes/smartvarme-theme/functions.php
autonomous: true

must_haves:
  truths:
    - "Active plugin count is under 15 (verified in WP-CLI plugin list)"
    - "All critical features from removed plugins still work (forms, search, product display, checkout)"
    - "WooCommerce assets only load on shop/cart/checkout/account pages"
    - "Formidable Forms assets only load on pages with forms"
    - "Autoload monitoring warns admin when size exceeds 800KB"
    - "Expired transients are cleaned up automatically on a weekly schedule"
    - "Hero/LCP images are excluded from lazy loading"
    - "All plugin functionality is mapped with replacement strategy documented in SUMMARY"
  artifacts:
    - path: "wp-content/plugins/smartvarme-core/includes/class-smartvarme-performance.php"
      provides: "Asset loading control, lazy loading exclusions, autoload monitoring, transient cleanup"
      contains: "class Smartvarme_Performance"
    - path: "wp-content/plugins/smartvarme-core/includes/class-smartvarme-core.php"
      provides: "Performance module loading"
      contains: "load_performance_module"
  key_links:
    - from: "wp-content/plugins/smartvarme-core/includes/class-smartvarme-core.php"
      to: "wp-content/plugins/smartvarme-core/includes/class-smartvarme-performance.php"
      via: "require_once and instantiation in run()"
      pattern: "class-smartvarme-performance"
---

<objective>
Consolidate 35 plugins down to under 15 by inventorying all plugins, deactivating unnecessary ones, and migrating critical features to smartvarme-core. Add a performance optimization module to smartvarme-core that controls asset loading per page type, manages lazy loading exclusions for LCP elements, monitors autoload size, and schedules transient cleanup.

Purpose: Reduce plugin overhead (fewer HTTP requests, less PHP execution, smaller database footprint) and establish code-based performance optimizations that work independently of premium caching plugins.

Output: Plugin count under 15, performance module in smartvarme-core, conditional asset loading active.
</objective>

<execution_context>
@/Users/salesup/.claude/get-shit-done/workflows/execute-plan.md
@/Users/salesup/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-performance-plugin-optimization/06-RESEARCH.md
@wp-content/plugins/smartvarme-core/smartvarme-core.php
@wp-content/plugins/smartvarme-core/includes/class-smartvarme-core.php
@wp-content/themes/smartvarme-theme/functions.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Plugin inventory, consolidation, and deactivation</name>
  <files>wp-content/themes/smartvarme-theme/functions.php</files>
  <action>
  Inventory all 35 installed plugins and consolidate to under 15 active plugins.

  **Step 1: Get current plugin list**
  Run `npx wp-env run cli wp plugin list --format=csv` to get full plugin inventory with status.

  **Step 2: Categorize each plugin using this matrix:**

  KEEP (essential, no replacement):
  - woocommerce — Core e-commerce
  - dibs-easy-for-woocommerce — Payment gateway (DIBS/Nexi)
  - formidable + formidable-pro — Contact forms (Form ID 11 used on product pages)
  - smartvarme-core — Custom business logic
  - wordpress-seo (Yoast) — SEO management
  - wp-mail-smtp + wp-mail-smtp-pro — Email delivery (SMTP)
  - safe-svg — SVG upload security
  - unipulse-connect — Business integration
  - wp-fastest-cache — Keep active until WP Rocket is installed in Plan 06-02

  SKIP (do not activate - causes performance issues):
  - wordfence — Causes 50x slowdown (16s page loads), keep deactivated
  - duplicate-post — Not critical, keep deactivated

  DEACTIVATE (unnecessary or replaceable):
  - kadence-blocks — Only used for accordions; already migrated to native Details blocks in Phase 2
  - carousel-block — Evaluate usage; WooCommerce native gallery handles product images
  - block-pattern-builder — Not needed; theme has file-based patterns
  - advanced-custom-fields-pro — Evaluate; custom fields may use ACF
  - astra-addon — Old theme addon; Smartvarme uses custom block theme now
  - bulk-remove-posts-from-category — One-time utility, no longer needed
  - duracelltomi-google-tag-manager — Evaluate; if GTM not configured, deactivate
  - facebook-for-woocommerce — Evaluate; deactivate if Meta Pixel not active
  - formidable-charts — Evaluate; deactivate if no charts in use
  - loco-translate — Not needed; translations handled natively
  - log-emails — Debug utility, not needed in production
  - mgb-product-blocks — Evaluate; may conflict with custom blocks
  - redirection — Evaluate; keep if redirects actively managed, otherwise deactivate
  - string-locator — Developer utility, not needed in production
  - wc-add-to-cart-from-url — Evaluate; niche functionality
  - webappick-product-feed-for-woocommerce — Evaluate; keep if product feeds active
  - woo-added-to-cart-notification — Evaluate; WooCommerce has native notices
  - woo-product-feed-pro — Evaluate; may duplicate webappick feed plugin
  - woocommerce-product-bundles — Evaluate; keep only if product bundles actively used
  - woocommerce-table-rate-shipping — Evaluate; keep only if table rate shipping configured
  - wpforms-lite — Redundant with Formidable Forms
  - yith-woocommerce-bulk-product-editing-premium — Admin utility, deactivate unless actively used

  **Step 3: Before deactivating, verify no critical dependencies:**
  For each plugin marked DEACTIVATE:
  - Search content for shortcodes: `npx wp-env run cli wp db search "[shortcode_tag]" wp_posts --format=csv 2>/dev/null`
  - Check for ACF field groups if deactivating ACF: `npx wp-env run cli wp db query "SELECT COUNT(*) FROM wp_posts WHERE post_type='acf-field-group' AND post_status='publish'"`
  - Check for active redirects if deactivating Redirection: `npx wp-env run cli wp db query "SELECT COUNT(*) FROM wp_redirection_items WHERE status='enabled'" 2>/dev/null`

  **Step 4: Deactivate plugins via WP-CLI:**
  ```bash
  npx wp-env run cli wp plugin deactivate [plugin-slug]
  ```
  Deactivate one at a time, verifying site loads after each.

  **Step 5: Verify final plugin count:**
  ```bash
  npx wp-env run cli wp plugin list --status=active --format=count
  ```
  Must be under 15.

  **Step 6: Document plugin consolidation mapping**
  Create a plugin mapping table in the plan summary that documents every plugin and its status. This satisfies PLUG-03 ("All plugin functionality mapped to replacement strategy"). The table must include:

  | Plugin | Key Features | Replacement Strategy | Status |
  |--------|-------------|---------------------|--------|
  | kadence-blocks | Accordions, layouts | Migrated to native Details blocks (Phase 2) | Deactivated |
  | wp-fastest-cache | Page caching | Replaced by WP Rocket (Plan 06-02) | Deactivated |
  | wpforms-lite | Contact forms | Redundant — Formidable Forms handles all forms | Deactivated |
  | carousel-block | Image carousels | WooCommerce native gallery | Deactivated |
  | ... | ... | ... | ... |

  For each deactivated plugin, document: (a) what features it provided, (b) how those features are now handled (migrated, replaced, or no longer needed), (c) confirmation that no shortcodes/data depend on it.

  Store this mapping in the 06-01-SUMMARY.md under a dedicated `## Plugin Consolidation Mapping` section so it serves as a reference for future maintenance.

  **Important notes:**
  - Do NOT delete deactivated plugins yet (keep for rollback)
  - If ACF has active field groups, KEEP it (data depends on it)
  - If Redirection has active redirects AND no 301 redirect safety net handles them, KEEP it
  - The 301 redirect safety net was added in Phase 3 (class-smartvarme-woocommerce.php) for product URLs
  - WP Fastest Cache should be deactivated last (or kept until WP Rocket is installed in Plan 06-02)
  </action>
  <verify>
  Run `npx wp-env run cli wp plugin list --status=active --format=table` and count active plugins.
  Visit homepage, a product page, cart page, and contact page to verify no broken functionality.
  Run `npx wp-env run cli wp db search "[kadence" wp_posts --format=csv 2>/dev/null` to confirm no Kadence shortcodes remain.
  </verify>
  <done>Active plugin count is under 15. All pages load without errors. No shortcode rendering failures visible on frontend. Forms still submit. Product pages display correctly with stock/delivery info. Search works. Plugin consolidation mapping table documented in SUMMARY (every deactivated plugin has replacement strategy recorded).</done>
</task>

<task type="auto">
  <name>Task 2: Create performance optimization module in smartvarme-core</name>
  <files>
    wp-content/plugins/smartvarme-core/includes/class-smartvarme-performance.php
    wp-content/plugins/smartvarme-core/includes/class-smartvarme-core.php
  </files>
  <action>
  Create a new `Smartvarme_Performance` class in smartvarme-core that handles code-based performance optimizations.

  **File: wp-content/plugins/smartvarme-core/includes/class-smartvarme-performance.php**

  Create this class with the following methods:

  1. **Conditional Asset Loading** (`optimize_asset_loading`):
     Hook into `wp_enqueue_scripts` at priority 100 (late, to override plugin enqueues).
     - On non-WooCommerce pages (not is_woocommerce(), is_cart(), is_checkout(), is_account_page()):
       - Dequeue: `woocommerce-general`, `woocommerce-layout`, `woocommerce-smallscreen`, `wc-blocks-style` (styles)
       - Dequeue: `wc-cart-fragments`, `woocommerce`, `wc-add-to-cart` (scripts)
     - On pages without forms (not is_singular('product') and not is_page('contact') and not is_page('kontakt')):
       - Dequeue: `formidable` style and script
     - On non-search/archive pages (not is_search(), is_archive()):
       - Dequeue: `smartvarme-smart-search` script
     - IMPORTANT: Check function_exists('is_woocommerce') before calling WooCommerce conditionals
     - IMPORTANT: Do NOT dequeue `wc-cart-fragments` on pages that show mini-cart (check if mini-cart is in header — keep cart fragments on ALL pages if mini-cart header exists; otherwise only on WooCommerce pages)

  2. **Lazy Loading Control** (`control_lazy_loading`):
     Hook into `wp_lazy_loading_enabled` filter (priority 10, 3 args: $default, $tag_name, $context).
     - Use a static counter for images in `the_content` context
     - Disable lazy loading for the FIRST image (likely LCP/hero element)
     - Return $default for all other images (WordPress native lazy loading handles them)
     - Also add `wp_img_tag_add_decoding_attr` filter to set `decoding="async"` for below-fold images

  3. **Preload LCP Image** (`preload_lcp_image`):
     Hook into `wp_head` at priority 1 (very early).
     - On single product pages: preload the product featured image using `<link rel="preload" as="image">`
     - On homepage: preload the first image in content (if identifiable)
     - Use `fetchpriority="high"` attribute
     - Only preload if image URL is available (wp_get_attachment_image_src on featured image)

  4. **Autoload Size Monitoring** (`monitor_autoload_size`):
     Hook into `admin_notices` action.
     - Query: `SELECT SUM(LENGTH(option_value)) FROM $wpdb->options WHERE autoload = 'yes'`
     - Convert to KB, store in non-autoloaded option: `update_option('smartvarme_autoload_size_kb', $size_kb, false)`
     - Display admin notice if > 800KB (warning) or > 1024KB (error)
     - Include link to WP-Optimize or manual cleanup instructions
     - Only check once per day (use transient to throttle: `smartvarme_autoload_check` with 24h expiry)

  5. **Transient Cleanup** (`schedule_transient_cleanup`):
     On plugin init, schedule weekly cron event `smartvarme_transient_cleanup` if not already scheduled.
     - Cleanup handler: Delete expired transients using `DELETE FROM $wpdb->options WHERE option_name LIKE '_transient_timeout_%' AND option_value < UNIX_TIMESTAMP()`
     - Delete orphaned transient values (timeout deleted but value remains)
     - Log results to error_log with count of deleted transients

  6. **Remove Unnecessary WordPress Features** (`remove_bloat`):
     - Remove WordPress emoji scripts: `remove_action('wp_head', 'print_emoji_detection_script', 7)` and related
     - Remove RSD link: `remove_action('wp_head', 'rsd_link')`
     - Remove wlwmanifest link: `remove_action('wp_head', 'wlwmanifest_link')`
     - Remove WordPress version from head: `remove_action('wp_head', 'wp_generator')`
     - Disable XML-RPC: `add_filter('xmlrpc_enabled', '__return_false')`
     - Remove oEmbed discovery links: `remove_action('wp_head', 'wp_oembed_add_discovery_links')`
     - Remove REST API link from head (but keep REST API functional): `remove_action('wp_head', 'rest_output_link_wp_head')`
     - Disable self-pingbacks: filter `pre_ping` to remove self-URLs

  **File: wp-content/plugins/smartvarme-core/includes/class-smartvarme-core.php**

  Add a `load_performance_module` method and call it from `run()`:
  ```php
  private function load_performance_module() {
      require_once SMARTVARME_CORE_PATH . 'includes/class-smartvarme-performance.php';
      new Smartvarme_Performance();
  }
  ```
  Call `$this->load_performance_module()` in `run()` BEFORE the WooCommerce integration load (performance module should run early).
  </action>
  <verify>
  Run `npx wp-env run cli wp cron event list` and verify `smartvarme_transient_cleanup` is scheduled.
  Run `npx wp-env run cli wp eval "echo get_option('smartvarme_autoload_size_kb', 'not set');"` to verify monitoring works.
  Visit a blog post page and check browser DevTools Network tab — WooCommerce CSS/JS should NOT load.
  Visit a product page — WooCommerce CSS/JS SHOULD load, Formidable Forms SHOULD load.
  View page source — no emoji detection script, no RSD link, no wlwmanifest, no wp-generator meta tag.
  </verify>
  <done>Performance module loads without PHP errors. Conditional asset loading active (WooCommerce assets absent on non-shop pages). Lazy loading disabled for first image. Autoload monitoring shows current size in admin. Transient cleanup cron scheduled. WordPress bloat (emoji, RSD, generator) removed from page source.</done>
</task>

</tasks>

<verification>
1. Active plugin count under 15: `npx wp-env run cli wp plugin list --status=active --format=count`
2. No PHP errors on any page type (homepage, product, cart, blog, FAQ, contact)
3. WooCommerce assets not loaded on blog pages (check Network tab in browser DevTools)
4. Formidable Forms assets not loaded on homepage (check Network tab)
5. First image on page does NOT have `loading="lazy"` attribute
6. Autoload size admin notice visible if applicable
7. Transient cleanup cron event scheduled: `npx wp-env run cli wp cron event list | grep smartvarme`
8. Page source clean (no emoji script, no RSD, no generator)
</verification>

<success_criteria>
- Plugin count is under 15 active plugins (verified via WP-CLI)
- All features still work: product display, forms, search, checkout, FAQs
- Performance module loaded without errors
- Conditional asset loading reduces HTTP requests on non-shop pages
- LCP image not lazy loaded
- Autoload monitoring active
- Transient cleanup scheduled
</success_criteria>

<output>
After completion, create `.planning/phases/06-performance-plugin-optimization/06-01-SUMMARY.md`
</output>
