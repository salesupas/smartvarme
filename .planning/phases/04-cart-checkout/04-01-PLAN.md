---
phase: 04-cart-checkout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php
  - wp-content/themes/smartvarme-theme/parts/header.html
autonomous: true

must_haves:
  truths:
    - "Cart page exists with WooCommerce Cart block and displays added products with correct totals"
    - "Checkout page exists with WooCommerce Checkout block and shows billing/shipping fields"
    - "Mini-cart in header updates when product is added to cart"
    - "Cart, checkout, and my-account pages are excluded from page cache"
  artifacts:
    - path: "wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php"
      provides: "Cart/checkout page creation, cache exclusion verification"
      contains: "smartvarme_create_cart_page"
    - path: "wp-content/themes/smartvarme-theme/parts/header.html"
      provides: "Mini-Cart block in site header"
      contains: "woocommerce/mini-cart"
  key_links:
    - from: "WooCommerce cart page option"
      to: "Cart page with Cart block"
      via: "woocommerce_cart_page_id option"
      pattern: "woocommerce_cart_page_id"
    - from: "WooCommerce checkout page option"
      to: "Checkout page with Checkout block"
      via: "woocommerce_checkout_page_id option"
      pattern: "woocommerce_checkout_page_id"
    - from: "Header template"
      to: "Mini-Cart block"
      via: "FSE template part inclusion"
      pattern: "woocommerce/mini-cart"
---

<objective>
Create WooCommerce Cart and Checkout pages using native blocks, add Mini-Cart to header, and verify cache exclusions for dynamic pages.

Purpose: Establish the transaction flow foundation -- cart and checkout pages that users interact with to complete purchases, plus cache exclusions that prevent stale dynamic content.

Output: Working cart page at /handlekurv/, checkout page at /kasse/, Mini-Cart in header, verified cache exclusions for WooCommerce dynamic pages.
</objective>

<execution_context>
@/Users/salesup/.claude/get-shit-done/workflows/execute-plan.md
@/Users/salesup/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-cart-checkout/04-RESEARCH.md
@.planning/phases/03-woocommerce-setup-product-display/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cart and Checkout pages with WooCommerce blocks</name>
  <files>wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php</files>
  <action>
Add a method to Smartvarme_WooCommerce class that creates Cart and Checkout pages with WooCommerce blocks if they don't already exist. Hook it to `admin_init` or call it from an activation-like routine.

**Cart page:**
- Check if wc_get_page_id('cart') returns a valid, published page. If the page exists but uses the old [woocommerce_cart] shortcode, update its content to use the Cart block.
- If no valid cart page exists, create one with:
  - Title: "Handlekurv"
  - Content: `<!-- wp:woocommerce/cart /-->`
  - Status: publish
- Set `woocommerce_cart_page_id` option to the page ID.

**Checkout page:**
- Check if wc_get_page_id('checkout') returns a valid, published page. If the page exists but uses the old [woocommerce_checkout] shortcode, update its content to use the Checkout block.
- If no valid checkout page exists, create one with:
  - Title: "Kasse"
  - Content: `<!-- wp:woocommerce/checkout /-->`
  - Status: publish
- Set `woocommerce_checkout_page_id` option to the page ID.

**Order received page (already handled by Checkout block):**
- The Checkout block handles the order-received/thank-you endpoint internally. No separate page needed.

**My Account page:**
- Check if wc_get_page_id('myaccount') returns a valid, published page.
- If not, create one with:
  - Title: "Min konto"
  - Content: `<!-- wp:woocommerce/customer-account /-->`
  - Status: publish
- Set `woocommerce_myaccount_page_id` option to the page ID.

**Implementation approach:**
- Add method `ensure_woocommerce_pages()` to Smartvarme_WooCommerce class
- Hook to `admin_init` action at priority 99 (runs once per admin page load, lightweight check)
- Use a transient or option flag `smartvarme_wc_pages_checked` to avoid re-checking on every admin load. Only run the full check if the flag is not set. Set the flag after successful completion.
- For existing pages with shortcode content, use `wp_update_post()` to replace shortcode with block content
- Detection: check if post_content contains `[woocommerce_cart]` or `[woocommerce_checkout]` to identify shortcode pages needing upgrade

**Also run this via WP-CLI** after the code is deployed:
```bash
npx wp-env run cli wp eval "
  if (class_exists('Smartvarme_WooCommerce')) {
    // Trigger the page creation
    do_action('admin_init');
  }
"
```

Or alternatively, create the pages directly via WP-CLI:
```bash
# Check current cart page
npx wp-env run cli wp option get woocommerce_cart_page_id

# If cart page needs updating or creating, handle via WP-CLI
npx wp-env run cli wp eval "
  \$cart_id = wc_get_page_id('cart');
  if (\$cart_id <= 0 || get_post_status(\$cart_id) !== 'publish') {
    \$cart_id = wp_insert_post(array(
      'post_title' => 'Handlekurv',
      'post_content' => '<!-- wp:woocommerce/cart /-->',
      'post_status' => 'publish',
      'post_type' => 'page',
      'post_author' => 1,
    ));
    update_option('woocommerce_cart_page_id', \$cart_id);
    echo 'Cart page created: ' . \$cart_id;
  } else {
    \$post = get_post(\$cart_id);
    if (strpos(\$post->post_content, '[woocommerce_cart]') !== false) {
      wp_update_post(array('ID' => \$cart_id, 'post_content' => '<!-- wp:woocommerce/cart /-->'));
      echo 'Cart page updated to block: ' . \$cart_id;
    } else {
      echo 'Cart page OK: ' . \$cart_id;
    }
  }
"

# Same for checkout
npx wp-env run cli wp eval "
  \$checkout_id = wc_get_page_id('checkout');
  if (\$checkout_id <= 0 || get_post_status(\$checkout_id) !== 'publish') {
    \$checkout_id = wp_insert_post(array(
      'post_title' => 'Kasse',
      'post_content' => '<!-- wp:woocommerce/checkout /-->',
      'post_status' => 'publish',
      'post_type' => 'page',
      'post_author' => 1,
    ));
    update_option('woocommerce_checkout_page_id', \$checkout_id);
    echo 'Checkout page created: ' . \$checkout_id;
  } else {
    \$post = get_post(\$checkout_id);
    if (strpos(\$post->post_content, '[woocommerce_checkout]') !== false) {
      wp_update_post(array('ID' => \$checkout_id, 'post_content' => '<!-- wp:woocommerce/checkout /-->'));
      echo 'Checkout page updated to block: ' . \$checkout_id;
    } else {
      echo 'Checkout page OK: ' . \$checkout_id;
    }
  }
"

# My Account page
npx wp-env run cli wp eval "
  \$account_id = wc_get_page_id('myaccount');
  if (\$account_id <= 0 || get_post_status(\$account_id) !== 'publish') {
    \$account_id = wp_insert_post(array(
      'post_title' => 'Min konto',
      'post_content' => '<!-- wp:woocommerce/customer-account /-->',
      'post_status' => 'publish',
      'post_type' => 'page',
      'post_author' => 1,
    ));
    update_option('woocommerce_myaccount_page_id', \$account_id);
    echo 'My Account page created: ' . \$account_id;
  } else {
    echo 'My Account page OK: ' . \$account_id;
  }
"
```

Also add an `empty_cart_message` filter to show a Norwegian message with link to products:
```php
add_filter('wc_empty_cart_message', function($message) {
    return 'Din handlekurv er tom. <a href="' . esc_url(get_permalink(wc_get_page_id('shop'))) . '">Utforsk v&aring;re produkter</a>';
});
```
  </action>
  <verify>
Run these WP-CLI commands to verify:
```bash
# Verify cart page exists and uses block
npx wp-env run cli wp eval "
  \$id = wc_get_page_id('cart');
  \$post = get_post(\$id);
  echo 'Cart page ID: ' . \$id . PHP_EOL;
  echo 'Status: ' . get_post_status(\$id) . PHP_EOL;
  echo 'Has block: ' . (strpos(\$post->post_content, 'woocommerce/cart') !== false ? 'YES' : 'NO') . PHP_EOL;
"

# Verify checkout page exists and uses block
npx wp-env run cli wp eval "
  \$id = wc_get_page_id('checkout');
  \$post = get_post(\$id);
  echo 'Checkout page ID: ' . \$id . PHP_EOL;
  echo 'Status: ' . get_post_status(\$id) . PHP_EOL;
  echo 'Has block: ' . (strpos(\$post->post_content, 'woocommerce/checkout') !== false ? 'YES' : 'NO') . PHP_EOL;
"

# Verify my account page
npx wp-env run cli wp eval "
  \$id = wc_get_page_id('myaccount');
  echo 'My Account page ID: ' . \$id . PHP_EOL;
  echo 'Status: ' . get_post_status(\$id) . PHP_EOL;
"

# Verify cart page loads without errors
npx wp-env run cli wp eval "echo wp_remote_retrieve_response_code(wp_remote_get(home_url('/handlekurv/')));"

# Verify checkout page loads without errors
npx wp-env run cli wp eval "echo wp_remote_retrieve_response_code(wp_remote_get(home_url('/kasse/')));"

# PHP syntax check
php -l wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php
```
  </verify>
  <done>
Cart page exists at /handlekurv/ with WooCommerce Cart block content, checkout page exists at /kasse/ with WooCommerce Checkout block content, my-account page exists at /min-konto/ with account block, all pages are published and load without errors, WooCommerce page ID options are correctly set.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Mini-Cart to header and verify cache exclusions</name>
  <files>wp-content/themes/smartvarme-theme/parts/header.html</files>
  <action>
**Mini-Cart in header:**

Update the FSE header template part to include the WooCommerce Mini-Cart block. The header already has a cart icon (from Phase 1); replace or augment it with the proper Mini-Cart block that auto-updates via Interactivity API.

Read the current header.html template part first, then update it:
- Find the existing cart icon or navigation area in the header
- Add `<!-- wp:woocommerce/mini-cart /-->` in the appropriate position (right side of header, near navigation)
- The Mini-Cart block renders a cart icon with item count and opens a drawer on click
- No JavaScript needed -- Interactivity API handles live updates

If the header currently has a custom cart icon link (like `<a href="/cart/">` with an icon), replace it with the Mini-Cart block which provides the same functionality plus live updates.

**Cache exclusion verification:**

Verify that WP Fastest Cache (already installed) properly excludes WooCommerce pages. WP Fastest Cache has built-in WooCommerce auto-exclusions, but verify they are active.

Add a helper method to Smartvarme_WooCommerce class for cache exclusion verification:

```php
/**
 * Ensure WooCommerce pages are excluded from page cache.
 * WP Fastest Cache auto-handles this, but we verify and log warnings.
 */
public function verify_cache_exclusions() {
    // Set nocache headers for WooCommerce dynamic pages
    add_action('template_redirect', function() {
        if (function_exists('is_cart') && (is_cart() || is_checkout() || is_account_page())) {
            nocache_headers();
        }
    });
}
```

Call `verify_cache_exclusions()` from the constructor of Smartvarme_WooCommerce.

This ensures that even if WP Fastest Cache or any other cache plugin misses the exclusion, the HTTP headers explicitly mark cart/checkout/account pages as non-cacheable.

**Also verify via WP-CLI** that WP Fastest Cache has WooCommerce support active:
```bash
npx wp-env run cli wp eval "
  // Check WP Fastest Cache WooCommerce exclusion
  \$wpfc = get_option('WpFastestCache');
  echo 'WPFC Config: ' . print_r(\$wpfc, true);
"
```
  </action>
  <verify>
```bash
# Verify header.html contains Mini-Cart block
grep -q "woocommerce/mini-cart" wp-content/themes/smartvarme-theme/parts/header.html && echo "Mini-Cart block: FOUND" || echo "Mini-Cart block: MISSING"

# Verify cache exclusion code exists
grep -q "nocache_headers" wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php && echo "Cache exclusion: FOUND" || echo "Cache exclusion: MISSING"

# Verify cart page returns proper headers (no-cache)
npx wp-env run cli wp eval "
  \$cart_url = wc_get_cart_url();
  echo 'Cart URL: ' . \$cart_url . PHP_EOL;
"

# PHP syntax check
php -l wp-content/plugins/smartvarme-core/includes/class-smartvarme-woocommerce.php
```
  </verify>
  <done>
Header template contains WooCommerce Mini-Cart block that auto-updates on add-to-cart. Cache exclusion code sets nocache_headers for cart, checkout, and my-account pages. All PHP passes syntax validation.
  </done>
</task>

</tasks>

<verification>
1. Cart page exists and uses WooCommerce Cart block (not shortcode)
2. Checkout page exists and uses WooCommerce Checkout block (not shortcode)
3. My Account page exists with WooCommerce account block
4. WooCommerce page ID options (cart, checkout, myaccount) correctly set
5. All pages load without HTTP errors
6. Header contains Mini-Cart block
7. Cache exclusion headers set for dynamic WooCommerce pages
8. All PHP passes syntax validation
</verification>

<success_criteria>
- Cart page at /handlekurv/ renders WooCommerce Cart block
- Checkout page at /kasse/ renders WooCommerce Checkout block
- Mini-Cart block visible in site header
- nocache_headers set for cart, checkout, and my-account pages
- No PHP syntax errors in modified files
</success_criteria>

<output>
After completion, create `.planning/phases/04-cart-checkout/04-01-SUMMARY.md`
</output>
